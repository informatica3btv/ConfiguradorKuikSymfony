{# templates/home.html.twig (o donde lo tengas) #}
{% extends 'layout.html.twig' %}

{% block page_title %}Configurador{% endblock %}

{% block stylesheets %}
  {{ parent() }}
  <style>
    :root{
      /* ✅ no tocamos tu escala (la usa el JS) */
      --hscale: 4.16px;

      --kuik-blue-900:#003b73;
      --kuik-blue-700:#005fae;
      --kuik-blue-600:#0b76d8;
      --kuik-blue-500:#1187e6;

      --bg:#f6f9fc;
      --ink:#0b1220;
      --muted:#6b7280;
      --line: rgba(15, 23, 42, .12);

      --success:#2ecc71;
      --danger:#e74c3c;

      --shadow: 0 10px 25px rgba(2,20,60,.10);
      --shadow-sm: 0 6px 14px rgba(2,20,60,.10);

      --col-border:#000;
    }

    *, *::before, *::after{ box-sizing:border-box; }

    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--ink);
    }

    .page-wrap{
      max-width: 1100px;
      margin: 26px auto 60px;
      padding: 0 14px;
    }

    .page-head{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
      margin-bottom:16px;
    }

    .page-title{
      margin:0;
      font-size:34px;
      font-weight:900;
      letter-spacing:-0.02em;
    }
    .page-sub{
      margin-top:6px;
      color:var(--muted);
      font-size:15px;
    }

    .section-card{
      background:#fff;
      border:1px solid var(--line);
      border-radius:16px;
      padding:16px;
      margin-top:14px;
      box-shadow: 0 1px 0 rgba(15,23,42,.04);
    }

    .section-title{
      margin:0 0 10px;
      font-size:16px;
      font-weight:900;
    }

    .section-help{
      margin: -4px 0 12px;
      color:var(--muted);
      font-size:13px;
    }

    .option-row{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:12px;
    }
    .option-row[data-group="placement"]{ grid-template-columns:repeat(2,1fr); }
    .option-row[data-group="material"]{ grid-template-columns:repeat(2,1fr); }

    .option-card{
      padding:16px;
      border-radius:16px;
      border:1px solid #000;
      background:#fff;
      cursor:pointer;
      transition:.15s;
      text-align:left;
      box-shadow:  1px 0 rgba(15,23,42,.3);
    }
    .option-card:hover{ transform:translateY(-1px); box-shadow:var(--shadow-sm); }
    .option-card.selected{
      border-color:var(--kuik-blue-500);
      box-shadow:0 0 0 6px rgba(17,135,230,.15);
    }
    .option-title{ font-weight:900; font-size:15px; }
    .option-sub{ font-size:13px; color:var(--muted); margin-top:3px; }

    @media (max-width: 780px){
      .option-row{ grid-template-columns:1fr; }
      .option-row[data-group="placement"]{ grid-template-columns:1fr; }
      .option-row[data-group="material"]{ grid-template-columns:1fr; }
    }

    select{
      width:100%;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid #636363;
      background:#fff;
      font-size:14px;
    }
    select:focus{
      outline:none;
      box-shadow:0 0 0 4px rgba(17,135,230,.15);
    }

    .primary-btn{
      padding:12px 18px;
      border-radius:12px;
      border:1px solid rgba(11,118,216,.15);
      background: #0b76d8;
      color:#fff;
      font-weight:900;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:10px;
      transition:.15s;
      box-shadow: 0 10px 20px rgba(17,135,230,.18);
    }
    .primary-btn:hover{ filter: brightness(.98); transform: translateY(-1px); }

    .secondary-btn{
      padding:11px 16px;
      border-radius:12px;
      border:1px solid rgba(15,23,42,.12);
      background:#fff;
      font-weight:900;
      color:#0b1220;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:10px;
    }
    .secondary-btn:hover{ background: rgba(2,6,23,.03); }

    .builder-wrap{
      margin:0;
      padding:0;
      border:0;
      border-radius:0;
      background:transparent;
      box-shadow:none;
    }

    .builder-toolbar{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom:12px;
      padding:12px;
      border:1px solid var(--line);
      border-radius:14px;
      background:#f8fafc;
    }
    .builder-toolbar label{ font-weight:900; font-size:13px; color:#111827; }
    .builder-toolbar span{ color:var(--muted); }

    .columns-grid{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      padding:6px 2px 2px;
    }

    /* ====== TU DIBUJO ====== */
    .col-shell{
      width:190px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .col-toolbar-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:8px 10px;
      border-radius:12px;
      background: linear-gradient(135deg, var(--kuik-blue-900), var(--kuik-blue-700));
      color:#fff;
      font-weight:900;
      box-shadow: 0 6px 14px rgba(2,20,60,.10);
    }

    .col-actions{ display:flex; gap:8px; }
    .icon-btn{
      width:28px;
      height:28px;
      border-radius:999px;
      border:0;
      cursor:pointer;
      font-weight:900;
      line-height:28px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 6px 12px rgba(0,0,0,.10);
    }
    .icon-plus{ background:var(--success); color:#fff; }
    .icon-del{ background:var(--danger); color:#fff; }

    .col-card{
      width:190px;
      border-style:solid;
      border-color:var(--col-border);
      border-left-width:4px;
      border-right-width:4px;
      border-top-width:8px;
      border-bottom-width:8px;
      border-radius:12px;
      overflow:hidden;
      background:#f7f7f7;
      box-shadow: 0 10px 20px rgba(2,20,60,.08);
    }

    .col-body{
      height:calc(180 * var(--hscale));
      background:#eaeaea;
      display:flex;
      flex-direction:column;
      padding:0;
      gap:0;
    }

    .col-half{
      height:calc(90 * var(--hscale));
      display:flex;
      flex-direction:column;
      padding:0;
      gap:0;
      overflow:hidden;
    }

    .half-separator{
      border-top:2px dashed rgba(0,0,0,.25);
      height:0;
      margin:0;
    }

    .block{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      color:#0b0b0b;
      background:#3a9efc;

      border-left:2px solid #2c3e50;
      border-right:2px solid #2c3e50;
      border-top:2px solid #2c3e50;

      margin:0;
      border-radius:0;
      box-shadow:none;
      cursor:grab;
      position:relative;
    }
    .col-half .block:last-child{ border-bottom:2px solid #2c3e50; }

    .block.dragging{ opacity:.55; cursor:grabbing; }

    .block.screen{ padding:6px; }
    .block.screen img{
      width:125%;
      height:125%;
      object-fit:contain;
      pointer-events:none;
      user-select:none;
    }

    .block .delete-block{
      position:absolute;
      top:2px;
      right:6px;
      width:22px;
      height:22px;
      border-radius:999px;
      border:0;
      background:rgba(0,0,0,.75);
      color:#fff;
      font-weight:900;
      line-height:22px;
      cursor:pointer;
      opacity:0;
      transform:scale(.9);
      transition:.12s;
      pointer-events:none;
    }
    .block:hover .delete-block{
      opacity:1;
      transform:scale(1);
      pointer-events:auto;
    }
    .block .delete-block:hover{ background:rgba(231,76,60,.95); }

    .col-half.drag-over{
      outline:2px dashed rgba(0,0,0,.30);
      outline-offset:-2px;
    }
    .drop-indicator{
      height:6px;
      background:rgba(0,0,0,.25);
      margin:0;
      border-radius:0;
    }

    .col-foot{
      text-align:center;
      font-size:12px;
      padding:8px;
      background:#fff;
      border:1px solid rgba(15,23,42,.12);
      border-radius:12px;
      color:#111827;
    }

    .warn{ color:#c0392b; font-weight:900; }

    .config-form{
      max-width: 1100px;
      margin: 0;
      padding: 0;
      font-size:16px;
    }

    .grid-two{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 860px){
      .grid-two{ grid-template-columns: 1fr; }
    }

    .field label{
      display:block;
      font-weight:900;
      margin-bottom:8px;
      font-size:14px;
    }

    .form-actions{
      margin-top: 16px;
      display:flex;
      gap: 12px;
      align-items:center;
      flex-wrap:wrap;
    }
  </style>
{% endblock %}

{% block content %}
<div class="page-wrap">
  <div class="page-head">
    <div>
      <div class="page-sub">Configura el fondo, ubicación, material, colores y distribución de puertas.</div>
    </div>
  </div>

  <form method="post" action="{{ path('api_configurations_create') }}" id="configForm" class="config-form">
    <input type="hidden" name="placement" id="placement" value="">
    <input type="hidden" name="configuration_id" id="configuration_id" value="{{ configuration.id }}">
    <input type="hidden" name="project_id" id="project_id" value="{{ project.id }}">
    <input type="hidden" name="type" id="type" value="{{ type|default('') }}">

    {# =========================
       ATRIBUTOS DINÁMICOS
       ========================= #}
    {% for g in attributesGrouped %}
      {% set t = g.type %}
      {% if t %}

        {# ✅ clave = value del attributes_type (ej: fondo, material...) #}
        {% set groupKey = t.value %}

        <div class="section-card" data-attr-key="{{ groupKey }}">
          <h3 class="section-title">{{ t.name }}</h3>
          {% if t.description %}
            <div class="section-help">{{ t.description }}</div>
          {% endif %}

          {% if t.type == 'button' %}
            <input type="hidden" name="{{ groupKey }}" id="{{ groupKey }}" value="">

            <div class="option-row" data-group="{{ groupKey }}">
              {% for a in g.attributes %}
                <button type="button" class="option-card" data-value="{{ a.value }}">
                  <div class="option-title">{{ a.name }}</div>
                  {% if a.description %}
                    <div class="option-sub">{{ a.description }}</div>
                  {% endif %}
                </button>
              {% endfor %}
            </div>

          {% elseif t.type == 'selectable' %}
            <select name="{{ groupKey }}" id="{{ groupKey }}">
              <option value="" selected disabled>Selecciona {{ t.name|lower }}</option>
              {% for a in g.attributes %}
                <option value="{{ a.value }}">{{ a.name }}</option>
              {% endfor %}
            </select>
          {% endif %}
        </div>

      {% endif %}
    {% endfor %}

    <div class="section-card">
      <h3 class="section-title">Interior / Exterior</h3>
      <div class="section-help">Define la ubicación de la instalación.</div>

      <div class="option-row" data-group="placement">
        <button type="button" class="option-card" data-value="interior">
          <div class="option-title">Interior</div>
          <div class="option-sub">Uso interior</div>
        </button>
        <button type="button" class="option-card" data-value="exterior">
          <div class="option-title">Exterior</div>
          <div class="option-sub">Resistente a intemperie</div>
        </button>
      </div>
    </div>

    <div class="section-card">
      <h3 class="section-title">Colores</h3>
      <div class="section-help">Selecciona color de puerta y cuerpo.</div>

      <div class="grid-two">
        <div class="field">
          <label for="color-door">Color Puerta</label>
          <select name="color-door" id="color-door">
            <option value="" selected disabled>Selecciona un color</option>
            {% for color in coloresPuerta %}
              <option value="{{ color.hex }}">{{ color.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="field">
          <label for="color-body">Color Cuerpo</label>
          <select name="color-body" id="color-body">
            <option value="" selected disabled>Selecciona un color</option>
            {% for color in coloresCuerpo %}
              <option value="{{ color.hex }}">{{ color.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>

    <div class="section-card">
      <h3 class="section-title">Columnas</h3>
      <div class="section-help">Cada columna: H180 (2 mitades de H90). Añade puertas o pantalla.</div>

      <div class="builder-wrap">
        <div class="builder-toolbar">
          <button type="button" id="addColumnBtn" class="secondary-btn">+ Añadir columna</button>

          <label for="itemTypeSelect">Elemento:</label>
          <select id="itemTypeSelect" style="max-width:180px;">
            <option value="door" selected>Puerta</option>
            <option value="screen">Pantalla (H30)</option>
          </select>

          <label for="hSizeSelect">Tamaño a añadir:</label>
          <select id="hSizeSelect" style="max-width:180px;">
            {% for h in [10,20,30,40,50,60,70,80,90] %}
              <option value="{{ h }}">H{{ h }}</option>
            {% endfor %}
          </select>

          <span style="font-size:12px; opacity:.75;">(Cada columna: H180 = 2 mitades de H90)</span>
          <span id="builderMsg" class="warn"></span>
        </div>

        <div class="columns-grid" id="columnsGrid"></div>
      </div>
    </div>

    <div class="section-card">
      <h3 class="section-title">Hardware</h3>
      <select name="hardware" id="hardware">
        <option value="" selected disabled>Selecciona un hardware</option>
        <option value="kuikandcollect">Intelio Kuik&Collect</option>
        <option value="residencial">Intelio Residencial</option>
        <option value="custodia">Custodia</option>
        <option value="custodiaconpagofisico">Custodia con pago físico</option>
      </select>
    </div>

    <div class="section-card">
      <h3 class="section-title">Puertas periféricos</h3>
      <select name="periferico" id="periferico">
        <option value="" selected disabled>Selecciona el periférico</option>
        <option value="collect">Electrónica KUIK COLLECT</option>
        <option value="consigna">Electrónica KUIK CONSIGNA SIN PAGO</option>
        <option value="consignasinpagoycontrol">Electrónica KUIK CONSIGNA SIN PAGO + CONTROL ACCESO</option>
      </select>
    </div>

    <div class="section-card">
      <h3 class="section-title">Licencia de Software</h3>
      <select name="softwareLicense" id="softwareLicense">
        <option value="" selected disabled>Selecciona una licencia de software</option>
        <option value="licencia1">Licencia de Software Intelio Click&Collect – Cesión de uso del software según servicio de mantenimiento de software contratado.; Plataforma de control en remoto</option>
        <option value="licencia2">Licencia de Software Intelio Residencial – Cesión de uso del software según servicio de mantenimiento de software contratado.; Plataforma de control en remoto</option>
        <option value="licencia3">Licencia de Software Custodia BASIC – Control de hasta 15 puertas; Plataforma de gestión con motor de reservas y pago en la nube; Plataforma de control en remoto; Maquetación de página web</option>
      </select>
    </div>

    <div class="form-actions">
      <button type="submit" class="primary-btn">Siguiente</button>
      <div id="formError" class="warn"></div>
    </div>
  </form>
</div>
{% endblock %}

{% block javascripts %}
  {{ parent() }}

  <script>
    window.PRELOADED_CONFIG = {{ (payload ?? {})|json_encode|raw }};
  </script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
  (function() {

    // -------- Selección de cards --------
    function setSelected(group, value, btn) {
      document.querySelectorAll('.option-row[data-group="' + group + '"] .option-card')
        .forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');

      const input = document.getElementById(group);
      if (input) input.value = value;
    }

    document.querySelectorAll('.option-row .option-card').forEach(btn => {
      btn.addEventListener('click', function() {
        const row = btn.closest('.option-row');
        const group = row.getAttribute('data-group');
        const value = btn.getAttribute('data-value');
        setSelected(group, value, btn);
      });
    });

    // -------- Column builder (2 mitades H90) --------
    const hScale = 4.16;
    const state = { columns: [], selectedColor: '' };

    const columnsGrid = document.getElementById('columnsGrid');
    const addColumnBtn = document.getElementById('addColumnBtn');
    const itemTypeSelect = document.getElementById('itemTypeSelect');
    const hSizeSelect = document.getElementById('hSizeSelect');
    const builderMsg = document.getElementById('builderMsg');
    const colorDoorSelect = document.getElementById('color-door');
    const colorBodySelect = document.getElementById('color-body');

    function setColumnsBorderColor(hex){
      document.documentElement.style.setProperty('--col-border', hex || '#000');
    }

    function uid() {
      return Math.random().toString(16).slice(2) + Date.now().toString(16);
    }

    function normalizeBlock(b){
      if (typeof b === 'number') return { type:'door', h: b };
      if (b && typeof b === 'object' && b.type && b.h) return b;
      return { type:'door', h: 10 };
    }
    function blockHeight(b){
      const nb = normalizeBlock(b);
      return parseInt(nb.h, 10) || 0;
    }

    function syncSizeControl(){
      const isScreen = (itemTypeSelect?.value === 'screen');
      if (hSizeSelect){
        hSizeSelect.disabled = isScreen;
        if (isScreen) hSizeSelect.value = '30';
      }
    }
    itemTypeSelect?.addEventListener('change', syncSizeControl);
    syncSizeControl();

    function render() {
      columnsGrid.innerHTML = '';
      builderMsg.textContent = '';

      state.columns.forEach((col, idx) => {

        const shell = document.createElement('div');
        shell.className = 'col-shell';

        const topBar = document.createElement('div');
        topBar.className = 'col-toolbar-top';

        const title = document.createElement('div');
        title.textContent = `Columna ${idx + 1}`;

        const actions = document.createElement('div');
        actions.className = 'col-actions';

        const plus = document.createElement('button');
        plus.type = 'button';
        plus.className = 'icon-btn icon-plus';
        plus.textContent = '+';
        plus.title = 'Añadir bloque';

        plus.addEventListener('click', () => {
          const type = itemTypeSelect?.value || 'door';
          const h = (type === 'screen') ? 30 : parseInt(hSizeSelect.value, 10);

          const newBlock = { type, h };

          if (col.top.sum + h <= 90) {
            col.top.blocks.push(newBlock);
            col.top.sum += h;
            render();
            return;
          }

          if (col.bottom.sum + h <= 90) {
            col.bottom.blocks.push(newBlock);
            col.bottom.sum += h;
            render();
            return;
          }

          const topLeft = 90 - col.top.sum;
          const botLeft = 90 - col.bottom.sum;
          builderMsg.textContent = `No cabe H${h} en Columna ${idx + 1}. Libres: arriba H${topLeft}, abajo H${botLeft}.`;
        });

        const del = document.createElement('button');
        del.type = 'button';
        del.className = 'icon-btn icon-del';
        del.textContent = '×';
        del.title = 'Eliminar columna';
        del.addEventListener('click', () => {
          state.columns = state.columns.filter(c => c.id !== col.id);
          render();
        });

        actions.appendChild(plus);
        actions.appendChild(del);

        topBar.appendChild(title);
        topBar.appendChild(actions);

        const card = document.createElement('div');
        card.className = 'col-card';

        const body = document.createElement('div');
        body.className = 'col-body';

        let dragInfo = null;
        let dropIndicator = null;

        function ensureIndicator() {
          if (!dropIndicator) {
            dropIndicator = document.createElement('div');
            dropIndicator.className = 'drop-indicator';
          }
          return dropIndicator;
        }

        function cleanupIndicator() {
          if (dropIndicator && dropIndicator.parentNode) {
            dropIndicator.parentNode.removeChild(dropIndicator);
          }
        }

        function getInsertIndex(halfEl, y) {
          const blocks = Array.from(halfEl.querySelectorAll('.block:not(.dragging)'));
          for (let i = 0; i < blocks.length; i++) {
            const r = blocks[i].getBoundingClientRect();
            const mid = r.top + r.height / 2;
            if (y < mid) return i;
          }
          return blocks.length;
        }

        function placeIndicator(halfEl, index) {
          const ind = ensureIndicator();
          const blocks = Array.from(halfEl.querySelectorAll('.block:not(.dragging)'));
          if (index >= blocks.length) halfEl.appendChild(ind);
          else halfEl.insertBefore(ind, blocks[index]);
        }

        function moveWithinHalf(halfName, from, to) {
          const arr = (halfName === 'top') ? col.top.blocks : col.bottom.blocks;
          if (from === to) return;

          const [moved] = arr.splice(from, 1);

          if (to < 0) to = 0;
          if (to > arr.length) to = arr.length;

          arr.splice(to, 0, moved);
        }

        function makeBlock(block, halfName, fromIndex) {
          const nb = normalizeBlock(block);
          const h = blockHeight(nb);

          const b = document.createElement('div');
          b.className = 'block' + (nb.type === 'screen' ? ' screen' : '');
          b.style.height = (h * hScale) + 'px';
          b.draggable = true;

          if (state.selectedColor) b.style.background = state.selectedColor;

          if (nb.type === 'screen') {
            const img = document.createElement('img');
            img.src = '/assets/pantalla.png';
            img.alt = 'Pantalla';
            b.appendChild(img);
          } else {
            const label = document.createElement('div');
            label.textContent = `H${h}`;
            b.appendChild(label);
          }

          const delBtn = document.createElement('button');
          delBtn.type = 'button';
          delBtn.className = 'delete-block';
          delBtn.textContent = '×';
          delBtn.title = 'Eliminar';

          delBtn.addEventListener('mousedown', (e) => e.stopPropagation());
          delBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            e.preventDefault();

            const targetHalf = (halfName === 'top') ? col.top : col.bottom;

            if (typeof fromIndex === 'number' && fromIndex >= 0) {
              const removed = targetHalf.blocks.splice(fromIndex, 1)[0];
              targetHalf.sum -= blockHeight(removed);
              render();
            }
          });

          b.appendChild(delBtn);

          b.addEventListener('dragstart', (e) => {
            dragInfo = { colId: col.id, half: halfName, fromIndex };
            b.classList.add('dragging');
            e.dataTransfer.setData('text/plain', JSON.stringify(dragInfo));
            e.dataTransfer.effectAllowed = 'move';
          });

          b.addEventListener('dragend', () => {
            b.classList.remove('dragging');
            dragInfo = null;
            cleanupIndicator();
          });

          return b;
        }

        function wireHalfDnD(halfEl, halfName) {
          halfEl.addEventListener('dragover', (e) => {
            e.preventDefault();

            const data = dragInfo || (() => {
              try { return JSON.parse(e.dataTransfer.getData('text/plain')); } catch { return null; }
            })();

            if (!data || data.colId !== col.id || data.half !== halfName) {
              cleanupIndicator();
              return;
            }

            const idx = getInsertIndex(halfEl, e.clientY);
            placeIndicator(halfEl, idx);
            e.dataTransfer.dropEffect = 'move';
            halfEl.classList.add('drag-over');
          });

          halfEl.addEventListener('dragleave', (e) => {
            if (!halfEl.contains(e.relatedTarget)) {
              halfEl.classList.remove('drag-over');
              cleanupIndicator();
            }
          });

          halfEl.addEventListener('drop', (e) => {
            e.preventDefault();
            halfEl.classList.remove('drag-over');

            const data = dragInfo || (() => {
              try { return JSON.parse(e.dataTransfer.getData('text/plain')); } catch { return null; }
            })();

            if (!data || data.colId !== col.id || data.half !== halfName) {
              cleanupIndicator();
              return;
            }

            const toIndex = getInsertIndex(halfEl, e.clientY);
            moveWithinHalf(halfName, data.fromIndex, toIndex);
            cleanupIndicator();
            render();
          });
        }

        const topHalf = document.createElement('div');
        topHalf.className = 'col-half';
        col.top.blocks.forEach((blk, i) => topHalf.appendChild(makeBlock(blk, 'top', i)));
        wireHalfDnD(topHalf, 'top');

        const sep = document.createElement('div');
        sep.className = 'half-separator';

        const bottomHalf = document.createElement('div');
        bottomHalf.className = 'col-half';
        col.bottom.blocks.forEach((blk, i) => bottomHalf.appendChild(makeBlock(blk, 'bottom', i)));
        wireHalfDnD(bottomHalf, 'bottom');

        body.appendChild(topHalf);
        body.appendChild(sep);
        body.appendChild(bottomHalf);

        card.appendChild(body);

        const foot = document.createElement('div');
        foot.className = 'col-foot';
        const total = col.top.sum + col.bottom.sum;
        foot.innerHTML = `Usado H${total}/180 · Arriba H${col.top.sum}/90 · Abajo H${col.bottom.sum}/90`;

        shell.appendChild(topBar);
        shell.appendChild(card);
        shell.appendChild(foot);

        columnsGrid.appendChild(shell);
      });
    }

    // ✅ Inicializa color puertas
    state.selectedColor = colorDoorSelect?.value || '';
    colorDoorSelect?.addEventListener('change', () => {
      state.selectedColor = colorDoorSelect.value || '';
      render();
    });

    // ✅ Inicializa borde columnas
    setColumnsBorderColor(colorBodySelect?.value || '#000');
    colorBodySelect?.addEventListener('change', () => {
      setColumnsBorderColor(colorBodySelect.value || '#000');
    });

    addColumnBtn.addEventListener('click', () => {
      state.columns.push({
        id: uid(),
        top: { blocks: [], sum: 0 },
        bottom: { blocks: [], sum: 0 }
      });
      render();
    });

    // =========================
    // CARGAR CONFIG (si existe)
    // =========================
    const pre = window.PRELOADED_CONFIG || null;

    function selectOption(group, value){
      if (!value) return;
      const btn = document.querySelector(`.option-row[data-group="${group}"] .option-card[data-value="${value}"]`);
      if (btn) btn.click();
    }

    function setSelectValue(sel, value){
      if (!sel || !value) return;
      sel.value = value;
    }

    function loadDynamicAttributes(pre){
      document.querySelectorAll('[data-attr-key]').forEach(sec => {
        const key = sec.getAttribute('data-attr-key');
        if (!key) return;

        const val = pre[key];
        if (!val) return;

        const row = sec.querySelector(`.option-row[data-group="${key}"]`);
        if (row){
          selectOption(key, val);
          return;
        }

        const sel = document.getElementById(key);
        if (sel && sel.tagName === 'SELECT'){
          sel.value = val;
        }
      });
    }

    if (pre && Object.keys(pre).length) {
      selectOption('placement', pre.placement);

      setSelectValue(colorDoorSelect, pre.colorDoor);
      state.selectedColor = pre.colorDoor || '';

      setSelectValue(colorBodySelect, pre.colorBody);
      setColumnsBorderColor(pre.colorBody || '#000');

      if (Array.isArray(pre.columns)) {
        state.columns = pre.columns.map(c => {
          const topBlocks = (c.top?.blocks || []).map(normalizeBlock);
          const bottomBlocks = (c.bottom?.blocks || []).map(normalizeBlock);

          const topSum = (c.top?.total ?? topBlocks.reduce((a,b)=>a+blockHeight(b),0));
          const bottomSum = (c.bottom?.total ?? bottomBlocks.reduce((a,b)=>a+blockHeight(b),0));

          return {
            id: uid(),
            top: { blocks: topBlocks, sum: topSum },
            bottom: { blocks: bottomBlocks, sum: bottomSum }
          };
        });
      }

      loadDynamicAttributes(pre);

      render();
    } else {
      render();
    }

    // Submit
    document.getElementById('configForm').addEventListener('submit', function(e) {
      const pl = document.getElementById('placement').value;
      const colorDoor = document.getElementById('color-door').value;
      const colorBody = document.getElementById('color-body').value;

      const error = document.getElementById('formError');
      error.textContent = '';

      if (!pl || !colorDoor || !colorBody) {
        e.preventDefault();
        error.textContent = 'Selecciona interior/exterior, color puerta y color cuerpo.';
        return;
      }

      if (state.columns.length === 0) {
        e.preventDefault();
        error.textContent = 'Añade al menos 1 columna.';
        return;
      }

      const incompleteIndex = state.columns.findIndex(c => c.top.sum !== 90 || c.bottom.sum !== 90);
      if (incompleteIndex !== -1) {
        e.preventDefault();
        const colNum = incompleteIndex + 1;
        const topLeft = 90 - state.columns[incompleteIndex].top.sum;
        const botLeft = 90 - state.columns[incompleteIndex].bottom.sum;

        error.textContent = `La columna ${colNum} no está completa. Falta: arriba H${Math.max(0, topLeft)}, abajo H${Math.max(0, botLeft)}.`;
        return;
      }

      const columnsPayload = state.columns.map(c => ({
        top: { blocks: c.top.blocks, total: c.top.sum },
        bottom: { blocks: c.bottom.blocks, total: c.bottom.sum },
        total: c.top.sum + c.bottom.sum
      }));

      const ensureHidden = (name, value) => {
        let el = document.querySelector('input[name="' + name + '"]');
        if (!el) {
          el = document.createElement('input');
          el.type = 'hidden';
          el.name = name;
          this.appendChild(el);
        }
        el.value = value;
      };

      ensureHidden.call(this, 'project_id', document.getElementById('project_id').value);
      ensureHidden.call(this, 'configuration_id', document.getElementById('configuration_id').value);
      ensureHidden.call(this, 'colorDoor', colorDoor);
      ensureHidden.call(this, 'colorBody', colorBody);

      const type = document.getElementById('type')?.value || '';

      const dynamicAttrs = {};
      document.querySelectorAll('[data-attr-key]').forEach(sec => {
        const key = sec.getAttribute('data-attr-key');
        if (!key) return;

        const el = document.getElementById(key);
        let val = '';

        if (el) {
          val = (el.value || '').trim();
        }

        if (!val) {
          const selectedBtn = sec.querySelector(`.option-row[data-group="${key}"] .option-card.selected`);
          if (selectedBtn) val = (selectedBtn.getAttribute('data-value') || '').trim();
        }

        if (val) dynamicAttrs[key] = val;
      });

      ensureHidden.call(this, 'payload', JSON.stringify({
        type: type,
        ...dynamicAttrs,
        placement: pl,
        colorDoor: colorDoor,
        colorBody: colorBody,
        columns: columnsPayload
      }));
    });

  })();
  });
  </script>
{% endblock %}
