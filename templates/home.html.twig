{# templates/home.html.twig (o donde lo tengas) #}
{% extends 'layout.html.twig' %}

{% block page_title %}Configurador{% endblock %}

{% block stylesheets %}
  {{ parent() }}
  <style>
    :root{
      /* ✅ no tocamos tu escala (la usa el JS) */
      --hscale: 4.16px;

      --kuik-blue-900:#003b73;
      --kuik-blue-700:#005fae;
      --kuik-blue-600:#0b76d8;
      --kuik-blue-500:#1187e6;

      --bg:#f6f9fc;
      --ink:#0b1220;
      --muted:#6b7280;
      --line: rgba(15, 23, 42, .12);

      --success:#2ecc71;
      --danger:#e74c3c;

      --shadow: 0 10px 25px rgba(2,20,60,.10);
      --shadow-sm: 0 6px 14px rgba(2,20,60,.10);

      --col-border:#000;
    }

    *, *::before, *::after{ box-sizing:border-box; }

    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--ink);
    }

    .page-wrap{
      max-width: 1100px;
      margin: 26px auto 60px;
      padding: 0 14px;
    }

    .page-head{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
      margin-bottom:16px;
    }

    .page-title{
      margin:0;
      font-size:34px;
      font-weight:900;
      letter-spacing:-0.02em;
    }
    .page-sub{
      margin-top:6px;
      color:var(--muted);
      font-size:15px;
    }

    .section-card{
      background:#fff;
      border:1px solid var(--line);
      border-radius:16px;
      padding:16px;
      margin-top:14px;
      box-shadow: 0 1px 0 rgba(15,23,42,.04);
    }

    .section-title{
      margin:0 0 10px;
      font-size:16px;
      font-weight:900;
    }

    .section-help{
      margin: -4px 0 12px;
      color:var(--muted);
      font-size:13px;
    }

    .option-row{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:12px;
    }
    .option-row[data-group="placement"]{ grid-template-columns:repeat(2,1fr); }
    .option-row[data-group="material"]{ grid-template-columns:repeat(2,1fr); }

    .option-card{
      padding:16px;
      border-radius:16px;
      border:1px solid #000;
      background:#fff;
      cursor:pointer;
      transition:.15s;
      text-align:left;
      box-shadow:  1px 0 rgba(15,23,42,.3);
    }
    .option-card:hover{ transform:translateY(-1px); box-shadow:var(--shadow-sm); }
    .option-card.selected{
      border-color:var(--kuik-blue-500);
      box-shadow:0 0 0 6px rgba(17,135,230,.15);
    }
    .option-title{ font-weight:900; font-size:15px; }
    .option-sub{ font-size:13px; color:var(--muted); margin-top:3px; }

    @media (max-width: 780px){
      .option-row{ grid-template-columns:1fr; }
      .option-row[data-group="placement"]{ grid-template-columns:1fr; }
      .option-row[data-group="material"]{ grid-template-columns:1fr; }
    }

    select{
      width:100%;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid #636363;
      background:#fff;
      font-size:14px;
    }
    select:focus{
      outline:none;
      box-shadow:0 0 0 4px rgba(17,135,230,.15);
    }

    .primary-btn{
      padding:12px 18px;
      border-radius:12px;
      border:1px solid rgba(11,118,216,.15);
      background: #0b76d8;
      color:#fff;
      font-weight:900;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:10px;
      transition:.15s;
      box-shadow: 0 10px 20px rgba(17,135,230,.18);
    }
    .primary-btn:hover{ filter: brightness(.98); transform: translateY(-1px); }

    .secondary-btn{
      padding:11px 16px;
      border-radius:12px;
      border:1px solid rgba(15,23,42,.12);
      background:#fff;
      font-weight:900;
      color:#0b1220;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:10px;
    }
    .secondary-btn:hover{ background: rgba(2,6,23,.03); }

    .builder-wrap{
      margin:0;
      padding:0;
      border:0;
      border-radius:0;
      background:transparent;
      box-shadow:none;
    }

    .builder-toolbar{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom:12px;
      padding:12px;
      border:1px solid var(--line);
      border-radius:14px;
      background:#f8fafc;
    }
    .builder-toolbar label{ font-weight:900; font-size:13px; color:#111827; }
    .builder-toolbar span{ color:var(--muted); }

    /* ✅ columnas */
    .columns-grid{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      padding:6px 2px 2px;
      align-items:flex-start; /* ✅ importante para drag */
    }

    /* ====== TU DIBUJO ====== */
    .col-shell{
      width:190px;
      display:flex;
      flex-direction:column;
      gap:8px;

      /* ✅ drag columnas */
      cursor:grab;
    }
    .col-shell.dragging-col{ opacity:.6; cursor:grabbing; }
    .col-shell.col-drop-left,
    .col-shell.col-drop-right{
      outline:2px dashed rgba(0,0,0,.35);
      outline-offset:6px;
    }

    .col-toolbar-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:8px 10px;
      border-radius:12px;
      background: linear-gradient(135deg, var(--kuik-blue-900), var(--kuik-blue-700));
      color:#fff;
      font-weight:900;
      box-shadow: 0 6px 14px rgba(2,20,60,.10);
    }

    .col-actions{ display:flex; gap:8px; }
    .icon-btn{
      width:28px;
      height:28px;
      border-radius:999px;
      border:0;
      cursor:pointer;
      font-weight:900;
      line-height:28px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 6px 12px rgba(0,0,0,.10);
    }
    .icon-plus{ background:var(--success); color:#fff; }
    .icon-del{ background:var(--danger); color:#fff; }

    .col-card{
      width:190px;
      border-style:solid;
      border-color:var(--col-border);
      border-left-width:4px;
      border-right-width:4px;
      border-top-width:8px;
      border-bottom-width:8px;
      border-radius:12px;
      overflow:hidden;
      background:#f7f7f7;
      box-shadow: 0 10px 20px rgba(2,20,60,.08);
    }

    .col-body{
      height:calc(180 * var(--hscale));
      background:#eaeaea;
      display:flex;
      flex-direction:column;
      padding:0;
      gap:0;
    }

    .col-half{
      height:calc(90 * var(--hscale));
      display:flex;
      flex-direction:column;
      padding:0;
      gap:0;
      overflow:hidden;
    }

    .half-separator{
      border-top:2px dashed rgba(0,0,0,.25);
      height:0;
      margin:0;
    }

    .block{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      color:#0b0b0b;
      background:#3a9efc;

      border-left:2px solid #2c3e50;
      border-right:2px solid #2c3e50;
      border-top:2px solid #2c3e50;

      margin:0;
      border-radius:0;
      box-shadow:none;
      cursor:grab;
      position:relative;
    }
    .col-half .block:last-child{ border-bottom:2px solid #2c3e50; }

    .block.dragging{ opacity:.55; cursor:grabbing; }

    .block.screen{ padding:6px; }
    .block.screen img{
      width:125%;
      height:125%;
      object-fit:contain;
      pointer-events:none;
      user-select:none;
    }

    .block .delete-block{
      position:absolute;
      top:2px;
      right:6px;
      width:22px;
      height:22px;
      border-radius:999px;
      border:0;
      background:rgba(0,0,0,.75);
      color:#fff;
      font-weight:900;
      line-height:22px;
      cursor:pointer;
      opacity:0;
      transform:scale(.9);
      transition:.12s;
      pointer-events:none;
    }
    .block:hover .delete-block{
      opacity:1;
      transform:scale(1);
      pointer-events:auto;
    }
    .block .delete-block:hover{ background:rgba(231,76,60,.95); }

    .col-half.drag-over{
      outline:2px dashed rgba(0,0,0,.30);
      outline-offset:-2px;
    }
    .drop-indicator{
      height:6px;
      background:rgba(0,0,0,.25);
      margin:0;
      border-radius:0;
    }

    .col-foot{
      text-align:center;
      font-size:12px;
      padding:8px;
      background:#fff;
      border:1px solid rgba(15,23,42,.12);
      border-radius:12px;
      color:#111827;
    }

    .warn{ color: #e74c3c !important; font-weight:900; }

    .config-form{
      max-width: 1100px;
      margin: 0;
      padding: 0;
      font-size:16px;
    }

    .grid-two{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 860px){
      .grid-two{ grid-template-columns: 1fr; }
    }

    .field label{
      display:block;
      font-weight:900;
      margin-bottom:8px;
      font-size:14px;
    }

    .form-actions{
      margin-top: 16px;
      display:flex;
      gap: 12px;
      align-items:center;
      flex-wrap:wrap;
    }

    /* =========================
       AGRUPACIÓN DE COLUMNAS
       ========================= */
    .groups-grid{
      display:flex;
      flex-direction:column;
      gap:14px;
      margin-top:10px;
    }

    .group-shell{
      border:1px dashed rgba(15,23,42,.22);
      border-radius:16px;
      background:rgba(255,255,255,.6);
      padding:12px;
    }

    .group-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }

    .group-title{
      font-weight:900;
      color:#0b1220;
    }

    .group-sub{
      font-size:12px;
      color:var(--muted);
    }

    .group-cols{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:flex-start;
    }


    .group-shell.active{
      border:2px solid rgba(17,135,230,.6);
      box-shadow: 0 0 0 6px rgba(17,135,230,.12);
      background: rgba(17,135,230,.04);
    }
    .group-head{ cursor:pointer; user-select:none; }
    .group-pick{ display:inline-flex; align-items:center; gap:8px; }
    .group-badge{
      font-size:12px;
      font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      background:#fff;
      border:1px solid rgba(15,23,42,.12);
    }
    .group-badge.active{
      background: rgba(17,135,230,.12);
      border-color: rgba(17,135,230,.45);
    }

  </style>
{% endblock %}

{% block content %}
<div class="page-wrap">
  <div class="page-head">
    <div>
      <div class="page-sub">Configura el fondo, ubicación, material, colores y distribución de puertas.</div>
    </div>
  </div>

  <form method="post" action="{{ path('api_configurations_create') }}" id="configForm" class="config-form">
    <input type="hidden" name="placement" id="placement" value="">
    <input type="hidden" name="configuration_id" id="configuration_id" value="{{ configuration.id }}">
    <input type="hidden" name="project_id" id="project_id" value="{{ project.id }}">
    <input type="hidden" name="type" id="type" value="{{ type|default('') }}">
    <input type="hidden" name="instalacion" id="instalacion" value="{{ instalacion|default('') }}">

    {# =========================
       ATRIBUTOS DINÁMICOS
       ========================= #}
    {% for g in attributesGrouped %}
      {% set t = g.type %}
      {% if t %}
        {% set groupKey = t.value %}

        <div class="section-card" data-attr-key="{{ groupKey }}">
          <h3 class="section-title">{{ t.name }}</h3>
          {% if t.description %}
            <div class="section-help">{{ t.description }}</div>
          {% endif %}

          {% if t.type == 'button' %}
            <input type="hidden" name="{{ groupKey }}" id="{{ groupKey }}" value="">

            <div class="option-row" data-group="{{ groupKey }}">
              {% for a in g.attributes %}
                <button type="button" class="option-card" data-value="{{ a.value }}">
                  <div class="option-title">{{ a.name }}</div>
                  {% if a.description %}
                    <div class="option-sub">{{ a.description }}</div>
                  {% endif %}
                </button>
              {% endfor %}
            </div>

          {% elseif t.type == 'selectable' %}
            <select name="{{ groupKey }}" id="{{ groupKey }}">
              <option value="" selected disabled>Selecciona {{ t.name|lower }}</option>
              {% for a in g.attributes %}
                <option value="{{ a.value }}">{{ a.name }}</option>
              {% endfor %}
            </select>
          {% endif %}
        </div>
      {% endif %}
    {% endfor %}

    <div class="section-card">
      <h3 class="section-title">Interior / Exterior</h3>
      <div class="section-help">Define la ubicación de la instalación.</div>

      <div class="option-row" data-group="placement">
        <button type="button" class="option-card" data-value="interior">
          <div class="option-title">Interior</div>
          <div class="option-sub">Uso interior</div>
        </button>
        <button type="button" class="option-card" data-value="exterior">
          <div class="option-title">Exterior</div>
          <div class="option-sub">Resistente a intemperie</div>
        </button>
      </div>
    </div>

    <div class="section-card">
      <h3 class="section-title">Colores</h3>
      <div class="section-help">Selecciona color de puerta y cuerpo.</div>

      <div class="grid-two">
        <div class="field">
          <label for="color-door">Color Puerta</label>
          <select name="color-door" id="color-door">
            <option value="" selected disabled>Selecciona un color</option>
            {% for color in coloresPuerta %}
              <option value="{{ color.hex }}" data-ral="{{ color.ral }}">{{ color.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="field">
          <label for="color-body">Color Cuerpo</label>
          <select name="color-body" id="color-body">
            <option value="" selected disabled>Selecciona un color</option>
            {% for color in coloresCuerpo %}
              <option value="{{ color.hex }}" data-ral="{{ color.ral }}">{{ color.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>

    <div class="section-card">
      <h3 class="section-title">Columnas</h3>
      <div> Añade puertas o pantalla.</div>

      <div class="builder-wrap">
        <div class="builder-toolbar">
          <button type="button" id="addColumnBtn" class="secondary-btn">+ Añadir columna</button>

          <label for="itemTypeSelect">Elemento:</label>
          <select id="itemTypeSelect" style="max-width:180px;">
            <option value="door" selected>Puerta</option>
            <option value="screen">Pantalla (H30)</option>
          </select>

          <label for="hSizeSelect">Tamaño a añadir:</label>
          <select id="hSizeSelect" style="max-width:180px;">
            {% for h in [10,20,30,40,50,60,70,80,90] %}
              <option value="{{ h }}">H{{ h }}</option>
            {% endfor %}
          </select>

          <span id="builderMsg" class="warn"></span>
        </div>

        {# ✅ antes era columns-grid, ahora agrupamos #}
        <div class="groups-grid" id="columnsGrid"></div>
      </div>
    </div>

    <div class="section-card">
      <h3 class="section-title">Hardware</h3>
      <select name="hardware" id="hardware">
        <option value="" selected disabled>Selecciona un hardware</option>
        <option value="kuikandcollect">Intelio Kuik&Collect</option>
        <option value="residencial">Intelio Residencial</option>
        <option value="custodia">Custodia</option>
        <option value="custodiaconpagofisico">Custodia con pago físico</option>
      </select>
    </div>

    <div class="section-card">
      <h3 class="section-title">Puertas periféricos</h3>
      <select name="periferico" id="periferico">
        <option value="" selected disabled>Selecciona el periférico</option>
        <option value="collect">Electrónica KUIK COLLECT</option>
        <option value="consigna">Electrónica KUIK CONSIGNA SIN PAGO</option>
        <option value="consignasinpagoycontrol">Electrónica KUIK CONSIGNA SIN PAGO + CONTROL ACCESO</option>
      </select>
    </div>

    <div class="section-card">
      <h3 class="section-title">Licencia de Software</h3>
      <select name="softwareLicense" id="softwareLicense">
        <option value="" selected disabled>Selecciona una licencia de software</option>
        <option value="licencia1">Licencia de Software Intelio Click&Collect – Cesión de uso del software según servicio de mantenimiento de software contratado.; Plataforma de control en remoto</option>
        <option value="licencia2">Licencia de Software Intelio Residencial – Cesión de uso del software según servicio de mantenimiento de software contratado.; Plataforma de control en remoto</option>
        <option value="licencia3">Licencia de Software Custodia BASIC – Control de hasta 15 puertas; Plataforma de gestión con motor de reservas y pago en la nube; Plataforma de control en remoto; Maquetación de página web</option>
      </select>
    </div>

    <div class="form-actions">
      <button type="submit" class="primary-btn">Siguiente</button>
      <div id="formError" class="warn"></div>
    </div>
  </form>
</div>
{% endblock %}

{% block javascripts %}
  {{ parent() }}

  <script>
    window.PRELOADED_CONFIG = {{ (payload ?? {})|json_encode|raw }};
  </script>

 <script>
document.addEventListener('DOMContentLoaded', () => {
(function() {

  // -------- Selección de cards --------
  function setSelected(group, value, btn) {
    document.querySelectorAll('.option-row[data-group="' + group + '"] .option-card')
      .forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');

    const input = document.getElementById(group);
    if (input) input.value = value;
  }

  document.querySelectorAll('.option-row .option-card').forEach(btn => {
    btn.addEventListener('click', function() {
      const row = btn.closest('.option-row');
      const group = row.getAttribute('data-group');
      const value = btn.getAttribute('data-value');
      setSelected(group, value, btn);
    });
  });

  // -------- Column builder --------
  const hScale = 4.16;

  // ✅ state con grupos + grupo activo
  const state = {
    columns: [],         // lista plana (compatibilidad / validaciones)
    groups: [],          // grupos variables
    selectedColor: '',
    activeGroupId: null  // ✅ grupo seleccionado
  };

  const columnsGrid = document.getElementById('columnsGrid');
  const addColumnBtn = document.getElementById('addColumnBtn');
  const itemTypeSelect = document.getElementById('itemTypeSelect');
  const hSizeSelect = document.getElementById('hSizeSelect');
  const builderMsg = document.getElementById('builderMsg');
  const colorDoorSelect = document.getElementById('color-door');
  const colorBodySelect = document.getElementById('color-body');

  function getSelectedRal(selectEl) {
    return selectEl?.selectedOptions?.[0]?.dataset?.ral || '';
  }

  function setColumnsBorderColor(hex){
    document.documentElement.style.setProperty('--col-border', hex || '#000');
  }

  function uid() {
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  // =========================
  // LAYOUT por type/instalacion
  // =========================
  const configType = (document.getElementById('type')?.value || '').trim();
  const instalacionCfg = (document.getElementById('instalacion')?.value || '').trim();

  const layout = {
    mode: 'professional',
    topCap: 90,
    bottomCap: 90,
    singleCap: 180
  };

  function addToolbarSelect({ id, label, values, defaultValue, onChange }) {
    const wrap = document.createElement('div');
    wrap.style.display = 'flex';
    wrap.style.alignItems = 'center';
    wrap.style.gap = '8px';

    const lab = document.createElement('label');
    lab.setAttribute('for', id);
    lab.textContent = label;

    const sel = document.createElement('select');
    sel.id = id;
    sel.style.maxWidth = '180px';

    values.forEach(v => {
      const opt = document.createElement('option');
      opt.value = String(v);
      opt.textContent = String(v);
      sel.appendChild(opt);
    });

    sel.value = String(defaultValue);
    sel.addEventListener('change', () => onChange(parseInt(sel.value, 10)));

    wrap.appendChild(lab);
    wrap.appendChild(sel);

    const toolbar = document.querySelector('.builder-toolbar');
    if (toolbar) {
      const msg = document.getElementById('builderMsg');
      if (msg) toolbar.insertBefore(wrap, msg);
      else toolbar.appendChild(wrap);
    }

    return sel;
  }

  // Si vienes editando, intenta leer caps guardados
  const preCaps = window.PRELOADED_CONFIG || {};

  if (configType === 'home') {
    if (instalacionCfg === 'zocalo') {
      layout.mode = 'home_zocalo';
      layout.bottomCap = 70; // fijo H70

      const preTop = parseInt(preCaps.topCap || '40', 10);
      layout.topCap = [40,50,60,70].includes(preTop) ? preTop : 40;

      addToolbarSelect({
        id: 'topCapSelect',
        label: 'Altura superior:',
        values: [40,50,60,70],
        defaultValue: layout.topCap,
        onChange: (v) => {
          layout.topCap = v;
          // recalcula sums
          state.columns.forEach(c => {
            c.top.sum = c.top.blocks.reduce((a,b)=>a+blockHeight(b),0);
            c.bottom.sum = c.bottom.blocks.reduce((a,b)=>a+blockHeight(b),0);
          });
          render();
        }
      });
    }

    if (instalacionCfg === 'empotrado' || instalacionCfg === 'soporte_suelo') {
      layout.mode = 'home_empotrado';

      const preSingle = parseInt(preCaps.singleCap || '40', 10);
      layout.singleCap = [40,50,60,70,80].includes(preSingle) ? preSingle : 40;

      addToolbarSelect({
        id: 'singleCapSelect',
        label: 'Altura módulo:',
        values: [40,50,60,70,80],
        defaultValue: layout.singleCap,
        onChange: (v) => {
          layout.singleCap = v;
          state.columns.forEach(c => {
            c.single.sum = c.single.blocks.reduce((a,b)=>a+blockHeight(b),0);
          });
          render();
        }
      });
    }
  }

  // =========================
  // BLOQUES helpers
  // =========================
  function normalizeBlock(b){
    if (typeof b === 'number') return { type:'door', h: b };
    if (b && typeof b === 'object' && b.type && b.h) return b;
    return { type:'door', h: 10 };
  }
  function blockHeight(b){
    const nb = normalizeBlock(b);
    return parseInt(nb.h, 10) || 0;
  }
  function isScreenBlock(b){
    return normalizeBlock(b).type === 'screen';
  }
  function hasAnyScreen(){
    return state.columns.some(c => {
      if (c.single) return c.single.blocks.some(isScreenBlock);
      return c.top.blocks.some(isScreenBlock) || c.bottom.blocks.some(isScreenBlock);
    });
  }

  function syncSizeControl(){
    const isScreen = (itemTypeSelect?.value === 'screen');
    if (hSizeSelect){
      hSizeSelect.disabled = isScreen;
      if (isScreen) hSizeSelect.value = '30';
    }
  }
  itemTypeSelect?.addEventListener('change', syncSizeControl);
  syncSizeControl();

  // =========================
  // AGRUPACIÓN VARIABLE + ACTIVO
  // =========================
  function getGroupMax() {
    if (layout.mode === 'professional') return 2;
    if (layout.mode === 'home_zocalo') return 3;
    if (layout.mode === 'home_empotrado') return 5;
    return 1;
  }

  function newGroup() {
    return { id: uid(), columns: [] };
  }

  function rebuildFlatColumnsFromGroups() {
    state.columns = state.groups.flatMap(g => g.columns);
  }

  function ensureAtLeastOneGroup() {
    if (state.groups.length === 0) state.groups.push(newGroup());
  }

  function ensureActiveGroup() {
    ensureAtLeastOneGroup();
    if (!state.activeGroupId) state.activeGroupId = state.groups[0].id;

    const exists = state.groups.some(g => g.id === state.activeGroupId);
    if (!exists) state.activeGroupId = state.groups[0].id;
  }

  function setActiveGroup(id) {
    state.activeGroupId = id;
  }

  // ✅ ahora añade columna al grupo activo (y si está lleno crea nuevo y lo activa)
  function addColumnToGroups(newCol) {
    ensureActiveGroup();
    const max = getGroupMax();

    let g = state.groups.find(x => x.id === state.activeGroupId);
    if (!g) g = state.groups[0];

    if (g.columns.length >= max) {
      const ng = newGroup();
      state.groups.push(ng);
      state.activeGroupId = ng.id;
      g = ng;
    }

    g.columns.push(newCol);
    rebuildFlatColumnsFromGroups();
  }

  // ✅ botón + Añadir grupo (lo crea y lo activa)
  (function injectAddGroupButton(){
    const toolbar = document.querySelector('.builder-toolbar');
    if (!toolbar) return;

    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'secondary-btn';
    btn.textContent = '+ Añadir grupo';
    btn.style.marginLeft = '6px';

    btn.addEventListener('click', () => {
      const g = newGroup();
      state.groups.push(g);
      state.activeGroupId = g.id;
      rebuildFlatColumnsFromGroups();
      render();
    });

    // lo metemos después de añadir columna
    toolbar.insertBefore(btn, toolbar.children[1] || null);
  })();

  // ✅ limpiar hints drop columnas
  function clearColDropHints(){
    document.querySelectorAll('.col-shell').forEach(s => {
      s.classList.remove('col-drop-left','col-drop-right');
    });
  }

  // =========================
  // RENDER
  // =========================
  function render() {
    columnsGrid.innerHTML = '';
    builderMsg.textContent = '';

    ensureActiveGroup();
    rebuildFlatColumnsFromGroups();

    state.groups.forEach((group, gIndex) => {
      const groupCols = group.columns;

      const groupShell = document.createElement('div');
      groupShell.className = 'group-shell';
      groupShell.dataset.groupId = group.id;

      if (group.id === state.activeGroupId) groupShell.classList.add('active');

      const head = document.createElement('div');
      head.className = 'group-head';

      // click en cabecera = activar grupo
      head.addEventListener('click', () => {
        setActiveGroup(group.id);
        render();
      });

      const gTitle = document.createElement('div');
      gTitle.className = 'group-title';

      const pick = document.createElement('div');
      pick.className = 'group-pick';

      const t = document.createElement('span');
      t.textContent = `Grupo ${gIndex + 1}`;

      const badge = document.createElement('span');
      badge.className = 'group-badge' + (group.id === state.activeGroupId ? ' active' : '');
      badge.textContent = (group.id === state.activeGroupId) ? 'Activo' : 'Seleccionar';

      pick.appendChild(t);
      pick.appendChild(badge);
      gTitle.appendChild(pick);

      const gSub = document.createElement('div');
      gSub.className = 'group-sub';
      gSub.textContent = `${groupCols.length} columna(s) · máx ${getGroupMax()}`;

      // botón borrar grupo (solo si vacío)
      const delGroup = document.createElement('button');
      delGroup.type = 'button';
      delGroup.className = 'icon-btn icon-del';
      delGroup.textContent = '×';
      delGroup.title = 'Eliminar grupo (si vacío)';
      delGroup.addEventListener('click', (e) => {
        e.stopPropagation(); // no activar al borrar
        if (group.columns.length > 0) return;
        state.groups = state.groups.filter(g => g.id !== group.id);
        ensureActiveGroup();
        rebuildFlatColumnsFromGroups();
        render();
      });

      head.appendChild(gTitle);
      head.appendChild(gSub);
      head.appendChild(delGroup);

      const groupRow = document.createElement('div');
      groupRow.className = 'group-cols';

      groupShell.appendChild(head);
      groupShell.appendChild(groupRow);

      groupCols.forEach((col) => {
        const globalList = state.groups.flatMap(g => g.columns);
        const globalIdx = globalList.findIndex(c => c.id === col.id);

        const shell = document.createElement('div');
        shell.className = 'col-shell';
        shell.dataset.colId = col.id;

        // DRAG & DROP de columnas (reorden global manteniendo tamaño de grupos)
        shell.draggable = true;

        shell.addEventListener('dragstart', (e) => {
          shell.classList.add('dragging-col');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', col.id);
        });

        shell.addEventListener('dragend', () => {
          shell.classList.remove('dragging-col');
          clearColDropHints();
        });

        shell.addEventListener('dragover', (e) => {
          e.preventDefault();

          const draggedId = e.dataTransfer.getData('text/plain');
          if (!draggedId || draggedId === col.id) return;

          const rect = shell.getBoundingClientRect();
          const isLeft = e.clientX < rect.left + rect.width / 2;

          shell.classList.toggle('col-drop-left', isLeft);
          shell.classList.toggle('col-drop-right', !isLeft);
        });

        shell.addEventListener('dragleave', (e) => {
          if (!shell.contains(e.relatedTarget)) {
            shell.classList.remove('col-drop-left','col-drop-right');
          }
        });

        shell.addEventListener('drop', (e) => {
          e.preventDefault();

          const draggedId = e.dataTransfer.getData('text/plain');
          if (!draggedId || draggedId === col.id) return;

          const flat = state.groups.flatMap(g => g.columns);
          const fromIndex = flat.findIndex(c => c.id === draggedId);
          const toIndex   = flat.findIndex(c => c.id === col.id);
          if (fromIndex === -1 || toIndex === -1) return;

          const rect = shell.getBoundingClientRect();
          const insertAfter = e.clientX >= rect.left + rect.width / 2;

          const [moved] = flat.splice(fromIndex, 1);

          let target = toIndex;
          if (fromIndex < toIndex) target = toIndex - 1;

          const finalIndex = insertAfter ? target + 1 : target;
          flat.splice(finalIndex, 0, moved);

          const sizes = state.groups.map(g => g.columns.length);
          const newGroups = state.groups.map(g => ({ id: g.id, columns: [] }));

          let cursor = 0;
          for (let i = 0; i < sizes.length; i++) {
            newGroups[i].columns = flat.slice(cursor, cursor + sizes[i]);
            cursor += sizes[i];
          }

          state.groups = newGroups.filter(g => g.columns.length > 0);
          ensureActiveGroup();
          rebuildFlatColumnsFromGroups();

          shell.classList.remove('col-drop-left','col-drop-right');
          render();
        });

        const topBar = document.createElement('div');
        topBar.className = 'col-toolbar-top';

        const title = document.createElement('div');
        title.textContent = `Columna ${globalIdx + 1}`;

        const actions = document.createElement('div');
        actions.className = 'col-actions';

        const plus = document.createElement('button');
        plus.type = 'button';
        plus.className = 'icon-btn icon-plus';
        plus.textContent = '+';
        plus.title = 'Añadir bloque';
        plus.addEventListener('mousedown', (e) => e.stopPropagation());

        plus.addEventListener('click', () => {
          const itemType = itemTypeSelect?.value || 'door';
          const h = (itemType === 'screen') ? 30 : parseInt(hSizeSelect.value, 10);

          if (itemType === 'screen' && hasAnyScreen()) {
            builderMsg.textContent = 'Solo se puede añadir 1 pantalla en toda la configuración.';
            return;
          }

          const newBlock = { type: itemType, h };

          if (layout.mode === 'home_empotrado') {
            if (col.single.sum + h <= layout.singleCap) {
              col.single.blocks.push(newBlock);
              col.single.sum += h;
              builderMsg.textContent = '';
              render();
              return;
            }
            const left = layout.singleCap - col.single.sum;
            builderMsg.textContent = `No cabe ${h} en Columna ${globalIdx + 1}. Libre: ${left}.`;
            return;
          }

          if (itemType === 'screen') {
            if (col.top.sum + h <= layout.topCap) {
              col.top.blocks.push(newBlock);
              col.top.sum += h;
              builderMsg.textContent = '';
              render();
              return;
            }
            const topLeft = layout.topCap - col.top.sum;
            builderMsg.textContent = `La pantalla solo puede ir arriba y no cabe. Libres arriba: ${topLeft}.`;
            return;
          }

          if (col.top.sum + h <= layout.topCap) {
            col.top.blocks.push(newBlock);
            col.top.sum += h;
            builderMsg.textContent = '';
            render();
            return;
          }

          if (col.bottom.sum + h <= layout.bottomCap) {
            col.bottom.blocks.push(newBlock);
            col.bottom.sum += h;
            builderMsg.textContent = '';
            render();
            return;
          }

          const topLeft = layout.topCap - col.top.sum;
          const botLeft = layout.bottomCap - col.bottom.sum;
          builderMsg.textContent = `No cabe ${h} en Columna ${globalIdx + 1}. Libres: arriba ${topLeft}, abajo ${botLeft}.`;
        });

        const del = document.createElement('button');
        del.type = 'button';
        del.className = 'icon-btn icon-del';
        del.textContent = '×';
        del.title = 'Eliminar columna';

        del.addEventListener('mousedown', (e) => e.stopPropagation());
        del.addEventListener('click', () => {
          // elimina de su grupo
          state.groups.forEach(g => {
            g.columns = g.columns.filter(c => c.id !== col.id);
          });
          state.groups = state.groups.filter(g => g.columns.length > 0);
          ensureActiveGroup();
          rebuildFlatColumnsFromGroups();
          render();
        });

        actions.appendChild(plus);
        actions.appendChild(del);

        topBar.appendChild(title);
        topBar.appendChild(actions);

        const card = document.createElement('div');
        card.className = 'col-card';

        const body = document.createElement('div');
        body.className = 'col-body';

        if (layout.mode === 'home_zocalo') {
          body.style.height = ((layout.topCap + layout.bottomCap) * hScale) + 'px';
        }
        if (layout.mode === 'home_empotrado') {
          body.style.height = (layout.singleCap * hScale) + 'px';
        }

        let dragInfo = null;
        let dropIndicator = null;

        function ensureIndicator() {
          if (!dropIndicator) {
            dropIndicator = document.createElement('div');
            dropIndicator.className = 'drop-indicator';
          }
          return dropIndicator;
        }

        function cleanupIndicator() {
          if (dropIndicator && dropIndicator.parentNode) {
            dropIndicator.parentNode.removeChild(dropIndicator);
          }
        }

        function getInsertIndex(zoneEl, y) {
          const blocks = Array.from(zoneEl.querySelectorAll('.block:not(.dragging)'));
          for (let i = 0; i < blocks.length; i++) {
            const r = blocks[i].getBoundingClientRect();
            const mid = r.top + r.height / 2;
            if (y < mid) return i;
          }
          return blocks.length;
        }

        function placeIndicator(zoneEl, index) {
          const ind = ensureIndicator();
          const blocks = Array.from(zoneEl.querySelectorAll('.block:not(.dragging)'));
          if (index >= blocks.length) zoneEl.appendChild(ind);
          else zoneEl.insertBefore(ind, blocks[index]);
        }

        function moveWithin(arr, from, to) {
          if (from === to) return;
          const [moved] = arr.splice(from, 1);
          if (to < 0) to = 0;
          if (to > arr.length) to = arr.length;
          arr.splice(to, 0, moved);
        }

        function makeBlock(block, zoneName, fromIndex) {
          const nb = normalizeBlock(block);
          const h = blockHeight(nb);

          const b = document.createElement('div');
          b.className = 'block' + (nb.type === 'screen' ? ' screen' : '');
          b.style.height = (h * hScale) + 'px';
          b.draggable = true;

          b.addEventListener('mousedown', (e) => e.stopPropagation());

          if (state.selectedColor) b.style.background = state.selectedColor;

          if (nb.type === 'screen') {
            const img = document.createElement('img');
            img.src = '/assets/pantalla.png';
            img.alt = 'Pantalla';
            b.appendChild(img);
          } else {
            const label = document.createElement('div');
            label.textContent = `H${h}`;
            b.appendChild(label);
          }

          const delBtn = document.createElement('button');
          delBtn.type = 'button';
          delBtn.className = 'delete-block';
          delBtn.textContent = '×';
          delBtn.title = 'Eliminar';

          delBtn.addEventListener('mousedown', (e) => e.stopPropagation());
          delBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            e.preventDefault();

            if (layout.mode === 'home_empotrado') {
              const removed = col.single.blocks.splice(fromIndex, 1)[0];
              col.single.sum -= blockHeight(removed);
              render();
              return;
            }

            const target = (zoneName === 'top') ? col.top : col.bottom;
            const removed = target.blocks.splice(fromIndex, 1)[0];
            target.sum -= blockHeight(removed);
            render();
          });

          b.appendChild(delBtn);

          b.addEventListener('dragstart', (e) => {
            dragInfo = { colId: col.id, zone: zoneName, fromIndex };
            b.classList.add('dragging');
            e.dataTransfer.setData('text/plain', JSON.stringify(dragInfo));
            e.dataTransfer.effectAllowed = 'move';
          });

          b.addEventListener('dragend', () => {
            b.classList.remove('dragging');
            dragInfo = null;
            cleanupIndicator();
          });

          return b;
        }

        function wireZoneDnD(zoneEl, zoneName, blocksArr) {
          zoneEl.addEventListener('dragover', (e) => {
            e.preventDefault();

            const data = dragInfo || (() => {
              try { return JSON.parse(e.dataTransfer.getData('text/plain')); } catch { return null; }
            })();

            if (!data || data.colId !== col.id || data.zone !== zoneName) {
              cleanupIndicator();
              return;
            }

            const idx = getInsertIndex(zoneEl, e.clientY);
            placeIndicator(zoneEl, idx);
            e.dataTransfer.dropEffect = 'move';
            zoneEl.classList.add('drag-over');
          });

          zoneEl.addEventListener('dragleave', (e) => {
            if (!zoneEl.contains(e.relatedTarget)) {
              zoneEl.classList.remove('drag-over');
              cleanupIndicator();
            }
          });

          zoneEl.addEventListener('drop', (e) => {
            e.preventDefault();
            zoneEl.classList.remove('drag-over');

            const data = dragInfo || (() => {
              try { return JSON.parse(e.dataTransfer.getData('text/plain')); } catch { return null; }
            })();

            if (!data || data.colId !== col.id || data.zone !== zoneName) {
              cleanupIndicator();
              return;
            }

            const toIndex = getInsertIndex(zoneEl, e.clientY);
            moveWithin(blocksArr, data.fromIndex, toIndex);
            cleanupIndicator();
            render();
          });
        }

        // ----- Construcción visual según layout -----
        if (layout.mode === 'home_empotrado') {
          const singleZone = document.createElement('div');
          singleZone.className = 'col-half';
          singleZone.style.height = (layout.singleCap * hScale) + 'px';

          col.single.blocks.forEach((blk, i) => singleZone.appendChild(makeBlock(blk, 'single', i)));
          wireZoneDnD(singleZone, 'single', col.single.blocks);

          body.appendChild(singleZone);
        } else {
          const topHalf = document.createElement('div');
          topHalf.className = 'col-half';

          const sep = document.createElement('div');
          sep.className = 'half-separator';

          const bottomHalf = document.createElement('div');
          bottomHalf.className = 'col-half';

          if (layout.mode === 'home_zocalo') {
            topHalf.style.height = (layout.topCap * hScale) + 'px';
            bottomHalf.style.height = (layout.bottomCap * hScale) + 'px';
          }

          col.top.blocks.forEach((blk, i) => topHalf.appendChild(makeBlock(blk, 'top', i)));
          wireZoneDnD(topHalf, 'top', col.top.blocks);

          col.bottom.blocks.forEach((blk, i) => bottomHalf.appendChild(makeBlock(blk, 'bottom', i)));
          wireZoneDnD(bottomHalf, 'bottom', col.bottom.blocks);

          body.appendChild(topHalf);
          body.appendChild(sep);
          body.appendChild(bottomHalf);
        }

        card.appendChild(body);

        const foot = document.createElement('div');
        foot.className = 'col-foot';

        if (layout.mode === 'home_empotrado') {
          foot.innerHTML = `Usado H${col.single.sum}/H${layout.singleCap}`;
        } else {
          const total = col.top.sum + col.bottom.sum;
          foot.innerHTML = `Usado H${total}/H${layout.topCap + layout.bottomCap} · Arriba H${col.top.sum}/H${layout.topCap} · Abajo H${col.bottom.sum}/H${layout.bottomCap}`;
        }

        shell.appendChild(topBar);
        shell.appendChild(card);
        shell.appendChild(foot);

        groupRow.appendChild(shell);
      });

      columnsGrid.appendChild(groupShell);
    });
  }

  // Inicializa color puertas
  state.selectedColor = colorDoorSelect?.value || '';
  colorDoorSelect?.addEventListener('change', () => {
    state.selectedColor = colorDoorSelect.value || '';
    render();
  });

  // Inicializa borde columnas
  setColumnsBorderColor(colorBodySelect?.value || '#000');
  colorBodySelect?.addEventListener('change', () => {
    setColumnsBorderColor(colorBodySelect.value || '#000');
  });

  // Añadir columna (según layout) -> ✅ ahora va a grupo activo
  addColumnBtn.addEventListener('click', () => {
    const newCol = (layout.mode === 'home_empotrado')
      ? { id: uid(), single: { blocks: [], sum: 0 } }
      : { id: uid(), top: { blocks: [], sum: 0 }, bottom: { blocks: [], sum: 0 } };

    addColumnToGroups(newCol);
    render();
  });

  // =========================
  // CARGAR CONFIG (si existe)
  // =========================
  const pre = window.PRELOADED_CONFIG || null;

  function selectOption(group, value){
    if (!value) return;
    const btn = document.querySelector(`.option-row[data-group="${group}"] .option-card[data-value="${value}"]`);
    if (btn) btn.click();
  }

  function setSelectValue(sel, value){
    if (!sel || !value) return;
    sel.value = value;
  }

  function loadDynamicAttributes(pre){
    document.querySelectorAll('[data-attr-key]').forEach(sec => {
      const key = sec.getAttribute('data-attr-key');
      if (!key) return;

      const val = pre[key];
      if (!val) return;

      const row = sec.querySelector(`.option-row[data-group="${key}"]`);
      if (row){
        selectOption(key, val);
        return;
      }

      const sel = document.getElementById(key);
      if (sel && sel.tagName === 'SELECT'){
        sel.value = val;
      }
    });
  }

  function buildColumnFromPayload(c){
    if (layout.mode === 'home_empotrado') {
      const blocks = (c.single?.blocks || []).map(normalizeBlock);
      const sum = (c.single?.total ?? blocks.reduce((a,b)=>a+blockHeight(b),0));
      return { id: uid(), single: { blocks, sum } };
    } else {
      const topBlocks = (c.top?.blocks || []).map(normalizeBlock);
      const bottomBlocks = (c.bottom?.blocks || []).map(normalizeBlock);

      const topSum = (c.top?.total ?? topBlocks.reduce((a,b)=>a+blockHeight(b),0));
      const bottomSum = (c.bottom?.total ?? bottomBlocks.reduce((a,b)=>a+blockHeight(b),0));

      return {
        id: uid(),
        top: { blocks: topBlocks, sum: topSum },
        bottom: { blocks: bottomBlocks, sum: bottomSum }
      };
    }
  }

  if (pre && Object.keys(pre).length) {
    selectOption('placement', pre.placement);

    setSelectValue(colorDoorSelect, pre.colorDoor);
    state.selectedColor = pre.colorDoor || '';

    setSelectValue(colorBodySelect, pre.colorBody);
    setColumnsBorderColor(pre.colorBody || '#000');

    if (layout.mode === 'home_zocalo' && pre.topCap) layout.topCap = parseInt(pre.topCap, 10) || layout.topCap;
    if (layout.mode === 'home_empotrado' && pre.singleCap) layout.singleCap = parseInt(pre.singleCap, 10) || layout.singleCap;

    if (Array.isArray(pre.groups) && pre.groups.length) {
      state.groups = pre.groups.map(groupCols => {
        const g = newGroup();
        g.columns = (groupCols || []).map(buildColumnFromPayload);
        return g;
      }).filter(g => g.columns.length > 0);

      ensureAtLeastOneGroup();
      state.activeGroupId = state.groups[0]?.id || null;
      rebuildFlatColumnsFromGroups();
    } else if (Array.isArray(pre.columns)) {
      const g = newGroup();
      g.columns = pre.columns.map(buildColumnFromPayload);
      state.groups = [g];

      ensureAtLeastOneGroup();
      state.activeGroupId = state.groups[0]?.id || null;
      rebuildFlatColumnsFromGroups();
    } else {
      ensureAtLeastOneGroup();
      state.activeGroupId = state.groups[0]?.id || null;
      rebuildFlatColumnsFromGroups();
    }

    loadDynamicAttributes(pre);
    render();
  } else {
    ensureAtLeastOneGroup();
    state.activeGroupId = state.groups[0]?.id || null;
    rebuildFlatColumnsFromGroups();
    render();
  }

  // =========================
  // SUBMIT
  // =========================
  document.getElementById('configForm').addEventListener('submit', function(e) {
    const pl = document.getElementById('placement').value;
    const colorDoor = document.getElementById('color-door').value;
    const colorBody = document.getElementById('color-body').value;

    const colorDoorRal = getSelectedRal(colorDoorSelect);
    const colorBodyRal = getSelectedRal(colorBodySelect);

    const error = document.getElementById('formError');
    error.textContent = '';

    if (!pl || !colorDoor || !colorBody) {
      e.preventDefault();
      error.textContent = 'Selecciona interior/exterior, color puerta y color cuerpo.';
      return;
    }

    rebuildFlatColumnsFromGroups();

    if (state.columns.length === 0) {
      e.preventDefault();
      error.textContent = 'Añade al menos 1 columna.';
      return;
    }

    let incompleteIndex = -1;

    if (layout.mode === 'home_empotrado') {
      incompleteIndex = state.columns.findIndex(c => c.single.sum !== layout.singleCap);
    } else {
      incompleteIndex = state.columns.findIndex(c => c.top.sum !== layout.topCap || c.bottom.sum !== layout.bottomCap);
    }

    if (incompleteIndex !== -1) {
      e.preventDefault();
      const colNum = incompleteIndex + 1;

      if (layout.mode === 'home_empotrado') {
        const left = layout.singleCap - state.columns[incompleteIndex].single.sum;
        error.textContent = `La columna ${colNum} no está completa. Falta: H${Math.max(0, left)}.`;
      } else {
        const topLeft = layout.topCap - state.columns[incompleteIndex].top.sum;
        const botLeft = layout.bottomCap - state.columns[incompleteIndex].bottom.sum;
        error.textContent = `La columna ${colNum} no está completa. Falta: arriba H${Math.max(0, topLeft)}, abajo H${Math.max(0, botLeft)}.`;
      }
      return;
    }

    let columnsPayload = [];
    if (layout.mode === 'home_empotrado') {
      columnsPayload = state.columns.map(c => ({
        single: { blocks: c.single.blocks, total: c.single.sum },
        total: c.single.sum
      }));
    } else {
      columnsPayload = state.columns.map(c => ({
        top: { blocks: c.top.blocks, total: c.top.sum },
        bottom: { blocks: c.bottom.blocks, total: c.bottom.sum },
        total: c.top.sum + c.bottom.sum
      }));
    }

    const groupsPayload = state.groups.map(g => {
      return g.columns.map(c => {
        if (layout.mode === 'home_empotrado') {
          return {
            single: { blocks: c.single.blocks, total: c.single.sum },
            total: c.single.sum
          };
        }
        return {
          top: { blocks: c.top.blocks, total: c.top.sum },
          bottom: { blocks: c.bottom.blocks, total: c.bottom.sum },
          total: c.top.sum + c.bottom.sum
        };
      });
    });

    const ensureHidden = (name, value) => {
      let el = document.querySelector('input[name="' + name + '"]');
      if (!el) {
        el = document.createElement('input');
        el.type = 'hidden';
        el.name = name;
        this.appendChild(el);
      }
      el.value = value;
    };

    ensureHidden.call(this, 'project_id', document.getElementById('project_id').value);
    ensureHidden.call(this, 'configuration_id', document.getElementById('configuration_id').value);

    ensureHidden.call(this, 'colorDoor', colorDoor);
    ensureHidden.call(this, 'colorDoorRal', colorDoorRal);
    ensureHidden.call(this, 'colorBody', colorBody);
    ensureHidden.call(this, 'colorBodyRal', colorBodyRal);

    const type = document.getElementById('type')?.value || '';
    const instalacion = document.getElementById('instalacion')?.value || '';

    const dynamicAttrs = {};
    document.querySelectorAll('[data-attr-key]').forEach(sec => {
      const key = sec.getAttribute('data-attr-key');
      if (!key) return;

      const el = document.getElementById(key);
      let val = '';

      if (el) val = (el.value || '').trim();

      if (!val) {
        const selectedBtn = sec.querySelector(`.option-row[data-group="${key}"] .option-card.selected`);
        if (selectedBtn) val = (selectedBtn.getAttribute('data-value') || '').trim();
      }

      if (val) dynamicAttrs[key] = val;
    });

    const extraLayout = {};
    if (type === 'home' && instalacion === 'zocalo') {
      extraLayout.topCap = layout.topCap;
    }

    if (type === 'home' && (instalacion === 'empotrado' || instalacion === 'soporte_suelo')) {
      extraLayout.singleCap = layout.singleCap;
    }

    ensureHidden.call(this, 'payload', JSON.stringify({
      type: type,
      instalacion: instalacion,

      groups: groupsPayload,
      columns: columnsPayload,

      ...extraLayout,
      ...dynamicAttrs,

      placement: pl,

      colorDoor: colorDoor,
      colorDoorRal: colorDoorRal,

      colorBody: colorBody,
      colorBodyRal: colorBodyRal
    }));
  });

})();
});
</script>


{% endblock %}
