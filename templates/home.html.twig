{% extends 'layout.html.twig' %}

{% block page_title %}Configurador{% endblock %}

{% block stylesheets %}
  {{ parent() }}
<style>
/* =========================
   RESET / BASE
   ========================= */
:root{
  --hscale: 2px;

  /* Paleta Kuik */
  --kuik-blue-900:#003b73;
  --kuik-blue-700:#005fae;
  --kuik-blue-600:#0b76d8;
  --kuik-blue-500:#1187e6;

  --bg:#f6f9fc;
  --ink:#0b1220;
  --muted:#6b7280;
  --line: rgba(15, 23, 42, .12);

  --success:#2ecc71;
  --danger:#e74c3c;

  --shadow: 0 10px 25px rgba(2,20,60,.10);
  --shadow-sm: 0 6px 14px rgba(2,20,60,.10);

  /* ✅ Color dinámico del borde de la columna (lo setea JS con el color-body) */
  --col-border: #000;
}

/* ✅ IMPORTANTÍSIMO: evita que los bordes “sumen” al height y corten puertas */
*, *::before, *::after{
  box-sizing: border-box;
}

body{
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background: var(--bg);
  color: var(--ink);
}

h1{
  font-size: 34px;
  font-weight: 800;
  letter-spacing: -0.02em;
}
h2{ margin-top: 28px; }
h3{
  font-size: 16px;
  font-weight: 800;
}

/* =========================
   OPCIONES (cards)
   ========================= */
.option-row{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:12px;
}
.option-row[data-group="placement"]{
  grid-template-columns:repeat(2,1fr);
}

.option-card{
  padding:14px;
  border-radius:16px;
  border:1px solid var(--line);
  background:#fff;
  cursor:pointer;
  transition:.15s;
}
.option-card:hover{
  transform:translateY(-1px);
  box-shadow:var(--shadow-sm);
}
.option-card.selected{
  border-color:var(--kuik-blue-500);
  box-shadow:0 0 0 4px rgba(17,135,230,.15);
}
.option-title{
  font-weight:800;
}
.option-sub{
  font-size:13px;
  color:var(--muted);
}

/* =========================
   SELECTS
   ========================= */
select{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:1px solid var(--line);
  background:#fff;
}
select:focus{
  outline:none;
  box-shadow:0 0 0 4px rgba(17,135,230,.15);
}

/* =========================
   BOTONES
   ========================= */
.primary-btn{
  padding:12px 20px;
  border-radius:999px;
  border:0;
  background:linear-gradient(135deg,var(--kuik-blue-600),var(--kuik-blue-500));
  color:#fff;
  font-weight:800;
  cursor:pointer;
  box-shadow:0 10px 20px rgba(17,135,230,.25);
  transition:.15s;
}
.primary-btn:hover{
  transform:translateY(-1px);
}

.secondary-btn{
  padding:11px 16px;
  border-radius:999px;
  border:1px solid rgba(17,135,230,.25);
  background:#fff;
  font-weight:800;
  color:var(--kuik-blue-700);
  cursor:pointer;
}

/* =========================
   BUILDER
   ========================= */
.builder-wrap{
  margin:18px 0;
  padding:14px;
  border:1px solid var(--line);
  border-radius:20px;
  background:#fff;
  box-shadow:var(--shadow);
}
.builder-toolbar{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
  margin-bottom:12px;
}
.builder-toolbar label{
  font-weight:800;
}

/* =========================
   GRID COLUMNAS
   ========================= */
.columns-grid{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
}

/* =========================
   ✅ NUEVO LAYOUT EXTERNO POR COLUMNA
   ========================= */
.col-shell{
  width:140px;
  display:flex;
  flex-direction:column;
  gap:6px;
}

/* ✅ menos redondeado */
.col-toolbar-top{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:6px 8px;
  border-radius:8px;
  background:linear-gradient(135deg,var(--kuik-blue-900),var(--kuik-blue-700));
  color:#fff;
  font-weight:900;
  box-shadow:var(--shadow-sm);
}

.col-actions{
  display:flex;
  gap:6px;
}
.icon-btn{
  width:26px;
  height:26px;
  border-radius:50%;
  border:0;
  cursor:pointer;
  font-weight:900;
  line-height:26px;
}
.icon-plus{ background:var(--success); }
.icon-del{ background:var(--danger); color:#fff; }

/* =========================
   DIBUJO COLUMNA
   - ✅ bordes el doble de grosor
   - ✅ color del borde con --col-border
   ========================= */
.col-card{
  width:140px;
  border-style:solid;
  border-color:var(--col-border);

  /* ✅ DOBLE grosor */
  border-left-width:4px;
  border-right-width:4px;

  /* ✅ arriba/abajo más grueso todavía */
  border-top-width:8px;
  border-bottom-width:8px;

  border-radius:8px;
  overflow:hidden;
  background:#f7f7f7;
}

.col-body{
  height:calc(180 * var(--hscale));
  background:#eaeaea;
  display:flex;
  flex-direction:column;
  padding:0;
  gap:0;
}

.col-half{
  height:calc(90 * var(--hscale));
  display:flex;
  flex-direction:column;
  padding:0;
  gap:0;
  overflow:hidden;
}

.half-separator{
  border-top:2px dashed rgba(0,0,0,.3);
  height:0;
  margin:0;
}

/* =========================
   PUERTAS / BLOQUES
   ========================= */
.block{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:900;
  color:#0b0b0b;
  background:#3a9efc;

  border-left:2px solid #2c3e50;
  border-right:2px solid #2c3e50;
  border-top:2px solid #2c3e50;

  margin:0;
  border-radius:0;
  box-shadow:none;

  cursor:grab;

  position:relative; /* ✅ para el botón eliminar */
}

.col-half .block:last-child{
  border-bottom:2px solid #2c3e50;
}

.block.dragging{
  opacity:.55;
  cursor:grabbing;
}

/* =========================
   ✅ BOTON ELIMINAR PUERTA (hover)
   ========================= */
.block .delete-block{
  position:absolute;
  top:2px;
  right:6px;
  width:22px;
  height:22px;
  border-radius:50%;
  border:0;
  background:rgba(0,0,0,.75);
  color:#fff;
  font-weight:900;
  line-height:22px;
  cursor:pointer;
  opacity:0;
  transform:scale(.9);
  transition:.12s;

  pointer-events:none; /* para que no interfiera hasta que se vea */
}

.block:hover .delete-block{
  opacity:1;
  transform:scale(1);
  pointer-events:auto;
}

.block .delete-block:hover{
  background:rgba(231,76,60,.95);
}

/* =========================
   DRAG & DROP
   ========================= */
.col-half.drag-over{
  outline:2px dashed rgba(0,0,0,.35);
  outline-offset:-2px;
}

.drop-indicator{
  height:6px;
  background:rgba(0,0,0,.35);
  margin:0;
  border-radius:0;
}

/* =========================
   ✅ FOOTER FUERA DEL DIBUJO
   - ✅ SIEMPRE NEGRO (no hereda el color-body)
   ========================= */
.col-foot{
  text-align:center;
  font-size:12px;
  padding:6px;
  background:#fff;
  border:2px solid #000; /* ✅ siempre negro */
  border-radius:8px;
}

/* =========================
   WARN
   ========================= */
.warn{
  color:#c0392b;
  font-weight:800;
}
/* =========================
   LAYOUT CENTRADO + MAS GRANDE
   ========================= */

.config-form{
  /* más ancho */
  max-width: 980px;
  margin: 28px auto 60px;
  padding: 10px 10px 30px;
}

/* un poco más grande todo dentro */
.config-form{
  font-size: 16px;
}

/* títulos más grandes */
.config-form h3{
  font-size: 18px;
}

/* cards más grandes */
.option-card{
  padding: 18px;
  border-radius: 18px;
}

/* texto dentro de cards */
.option-title{
  font-size: 16px;
}
.option-sub{
  font-size: 14px;
}

/* selects más grandes */
select{
  padding: 14px;
  border-radius: 16px;
  font-size: 15px;
}

/* botones más grandes */
.primary-btn{
  padding: 14px 24px;
  font-size: 15px;
}
.secondary-btn{
  padding: 13px 18px;
  font-size: 14px;
}

/* bloque “builder” un pelín más espacioso */
.builder-wrap{
  padding: 18px;
  border-radius: 22px;
}

/* columnas un poco más grandes (opcional, se nota bastante) */
.col-shell{ width: 160px; }
.col-card{ width: 160px; }

</style>
{% endblock %}

{% block content %}
<h1>{{type}}</h1>
<form method="post" action="/api/create-configuration" id="configForm" class="config-form">
  <input type="hidden" name="background_size" id="background_size" value="">
  <input type="hidden" name="placement" id="placement" value="">
  <input type="hidden" name="material" id="material" value="">
  <input type="hidden" name="user_id" id="user_id" value="{{app.user.id}}">
  <input type="hidden" name="configuration_id" id="configuration_id" value="{{ config_id ?? '' }}">
  <input type="hidden" name="type" id="type" value="{{ type|default('') }}">

  <div style="margin: 16px 0;">
    <h3 style="margin-bottom: 8px;">Medida de fondo</h3>
    <div class="option-row" data-group="background_size">
      <button type="button" class="option-card" data-value="small">
        <div class="option-title">Serie 300</div>
      </button>

      <button type="button" class="option-card" data-value="medium">
        <div class="option-title">Serie 400</div>
      </button>

      <button type="button" class="option-card" data-value="large">
        <div class="option-title">Serie 500</div>
      </button>
    </div>
  </div>

  <div style="margin: 16px 0;">
    <h3 style="margin-bottom: 8px;">Interior / Exterior</h3>
    <div class="option-row" data-group="placement">
      <button type="button" class="option-card" data-value="interior">
        <div class="option-title">Interior</div>
        <div class="option-sub">Uso interior</div>
      </button>

      <button type="button" class="option-card" data-value="exterior">
        <div class="option-title">Exterior</div>
        <div class="option-sub">Resistente a intemperie</div>
      </button>
    </div>
  </div>

  <div style="margin: 16px 0;">
    <h3 style="margin-bottom: 8px;">Material</h3>
    <div class="option-row" data-group="material">
      <button type="button" class="option-card" data-value="kuik">
        <div class="option-title">Kuik</div>
        <div class="option-sub">Material Kuik</div>
      </button>

      <button type="button" class="option-card" data-value="kuik2">
        <div class="option-title">Kuik2</div>
        <div class="option-sub">Material Kuik2</div>
      </button>
    </div>
  </div>


  <div style="margin: 16px 0;">
    <h3 style="margin-bottom: 8px;">Color Puerta</h3>
    <select name="color-door" id="color-door">
      <option value="" selected disabled>Selecciona un color</option>
      {% for color in coloresPuerta %}
        <option value="{{color.hex}}">{{color.name}}</option>
      {% endfor %}
    </select>
  </div>

  <div style="margin: 16px 0;">
    <h3 style="margin-bottom: 8px;">Color Cuerpo</h3>
    <select name="color-body" id="color-body">
      <option value="" selected disabled>Selecciona un color</option>
      {% for color in coloresCuerpo %}
        <option value="{{color.hex}}">{{color.name}}</option>
      {% endfor %}
    </select>
  </div>

  {# ====== Constructor de columnas ====== #}
  <div class="builder-wrap">
    <h3 style="margin: 0 0 10px;">Columnas</h3>

    <div class="builder-toolbar">
      <button type="button" id="addColumnBtn" class="secondary-btn">+ Añadir columna</button>

      <label for="hSizeSelect">Tamaño a añadir:</label>
      <select id="hSizeSelect" style="max-width:180px;">
        {% for h in [10,20,30,40,50,60,70,80,90] %}
          <option value="{{ h }}">H{{ h }}</option>
        {% endfor %}
      </select>

      <span style="font-size:12px; opacity:.75;">(Cada columna: H180 = 2 mitades de H90)</span>
      <span id="builderMsg" class="warn"></span>
    </div>

    <div class="columns-grid" id="columnsGrid"></div>
  </div>

   <div style="margin: 16px 0;">
    <h3 style="margin-bottom: 8px;">Hardware</h3>
    <select name="hardware" id="hardware">
      <option value="" selected disabled>Selecciona un hardware</option>
      <option value="kuikandcollect">Intelio Kuik&Collect</option>
      <option value="residencial">Intelio Residencial</option>
      <option value="custodia">Custodia</option>
      <option value="custodiaconpagofisico">Custodia con pago físico</option>
    </select>
  </div>

   <div style="margin: 16px 0;">
    <h3 style="margin-bottom: 8px;">Puertas periféricos</h3>
    <select name="color-body" id="color-body">
      <option value="" selected disabled>Selecciona el periférico</option>
      <option value="collect">Electrónica KUIK COLLECT</option>
      <option value="consigna">Electrónica KUIK CONSIGNA SIN PAGO</option>
      <option value="consignasinpagoycontrol">Electrónica KUIK CONSIGNA SIN PAGO + CONTROL ACCESO</option>
    </select>
  </div>

   <div style="margin: 16px 0;">
    <h3 style="margin-bottom: 8px;">Licencia de Software</h3>
    <select name="softwareLicense" id="softwareLicense">
      <option value="" selected disabled>Selecciona una licencia de software</option>
      <option value="licencia1">Licencia de Software Intelio Click&Collect – Cesión de uso del software según servicio de mantenimiento de software contratado.; Plataforma de control en remoto</option>
      <option value="licencia2">Licencia de Software Intelio Residencial – Cesión de uso del software según servicio de mantenimiento de software contratado.; Plataforma de control en remoto</option>
      <option value="licencia3">Licencia de Software Custodia BASIC – Control de hasta 15 puertas; Plataforma de gestión con motor de reservas y pago en la nube; Plataforma de control en remoto; Maquetación de página web</option>
    </select>
  </div>

  <div style="margin-top: 18px; display: flex; gap: 10px; align-items: center;">
    <button type="submit" class="primary-btn">Siguiente</button>
    <div id="formError" class="warn"></div>
  </div>
</form>

{% endblock %}

{% block javascripts %}
  {{ parent() }}

  {# ✅ PRELOADED antes del JS principal #}
  <script>
    window.PRELOADED_CONFIG = {{ (payload ?? {})|json_encode|raw }};
  </script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
  (function() {

    // -------- Selección de cards --------
    function setSelected(group, value, btn) {
      document.querySelectorAll('.option-row[data-group="' + group + '"] .option-card')
        .forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      document.getElementById(group).value = value;
    }

    document.querySelectorAll('.option-row .option-card').forEach(btn => {
      btn.addEventListener('click', function() {
        const row = btn.closest('.option-row');
        const group = row.getAttribute('data-group');
        const value = btn.getAttribute('data-value');
        setSelected(group, value, btn);
      });
    });

    // -------- Column builder (2 mitades H90) --------
    const hScale = 2; // debe coincidir con --hscale
    const state = { columns: [], selectedColor: '' };

    const columnsGrid = document.getElementById('columnsGrid');
    const addColumnBtn = document.getElementById('addColumnBtn');
    const hSizeSelect = document.getElementById('hSizeSelect');
    const builderMsg = document.getElementById('builderMsg');
    const colorDoorSelect = document.getElementById('color-door');
    const colorBodySelect = document.getElementById('color-body');

    // ✅ Aplica el color-body al borde de TODAS las columnas (builder + guardadas)
    function setColumnsBorderColor(hex){
      document.documentElement.style.setProperty('--col-border', hex || '#000');
    }

    function uid() {
      return Math.random().toString(16).slice(2) + Date.now().toString(16);
    }

    function render() {
      columnsGrid.innerHTML = '';
      builderMsg.textContent = '';

      state.columns.forEach((col, idx) => {

        const shell = document.createElement('div');
        shell.className = 'col-shell';

        const topBar = document.createElement('div');
        topBar.className = 'col-toolbar-top';

        const title = document.createElement('div');
        title.textContent = `Columna ${idx + 1}`;

        const actions = document.createElement('div');
        actions.className = 'col-actions';

        const plus = document.createElement('button');
        plus.type = 'button';
        plus.className = 'icon-btn icon-plus';
        plus.textContent = '+';
        plus.title = 'Añadir bloque (según tamaño seleccionado)';

        plus.addEventListener('click', () => {
          const h = parseInt(hSizeSelect.value, 10);

          if (col.top.sum + h <= 90) {
            col.top.blocks.push(h);
            col.top.sum += h;
            render();
            return;
          }

          if (col.bottom.sum + h <= 90) {
            col.bottom.blocks.push(h);
            col.bottom.sum += h;
            render();
            return;
          }

          const topLeft = 90 - col.top.sum;
          const botLeft = 90 - col.bottom.sum;
          builderMsg.textContent = `No cabe H${h} en Columna ${idx + 1}. Libres: arriba H${topLeft}, abajo H${botLeft}.`;
        });

        const del = document.createElement('button');
        del.type = 'button';
        del.className = 'icon-btn icon-del';
        del.textContent = '×';
        del.title = 'Eliminar columna';
        del.addEventListener('click', () => {
          state.columns = state.columns.filter(c => c.id !== col.id);
          render();
        });

        actions.appendChild(plus);
        actions.appendChild(del);

        topBar.appendChild(title);
        topBar.appendChild(actions);

        const card = document.createElement('div');
        card.className = 'col-card';

        const body = document.createElement('div');
        body.className = 'col-body';

        let dragInfo = null;
        let dropIndicator = null;

        function ensureIndicator() {
          if (!dropIndicator) {
            dropIndicator = document.createElement('div');
            dropIndicator.className = 'drop-indicator';
          }
          return dropIndicator;
        }

        function cleanupIndicator() {
          if (dropIndicator && dropIndicator.parentNode) {
            dropIndicator.parentNode.removeChild(dropIndicator);
          }
        }

        function getInsertIndex(halfEl, y) {
          const blocks = Array.from(halfEl.querySelectorAll('.block:not(.dragging)'));
          for (let i = 0; i < blocks.length; i++) {
            const r = blocks[i].getBoundingClientRect();
            const mid = r.top + r.height / 2;
            if (y < mid) return i;
          }
          return blocks.length;
        }

        function placeIndicator(halfEl, index) {
          const ind = ensureIndicator();
          const blocks = Array.from(halfEl.querySelectorAll('.block:not(.dragging)'));
          if (index >= blocks.length) halfEl.appendChild(ind);
          else halfEl.insertBefore(ind, blocks[index]);
        }

        function moveWithinHalf(halfName, from, to) {
          const arr = (halfName === 'top') ? col.top.blocks : col.bottom.blocks;
          if (from === to) return;

          const [moved] = arr.splice(from, 1);

          if (to < 0) to = 0;
          if (to > arr.length) to = arr.length;

          arr.splice(to, 0, moved);
        }

        function makeBlock(h, halfName, fromIndex) {
          const b = document.createElement('div');
          b.className = 'block';
          b.style.height = (h * hScale) + 'px';
          b.draggable = true;

          if (state.selectedColor) b.style.background = state.selectedColor;

          const label = document.createElement('div');
          label.textContent = `H${h}`;
          b.appendChild(label);

          const delBtn = document.createElement('button');
          delBtn.type = 'button';
          delBtn.className = 'delete-block';
          delBtn.textContent = '×';
          delBtn.title = 'Eliminar puerta';

          delBtn.addEventListener('mousedown', (e) => e.stopPropagation());
          delBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            e.preventDefault();

            const targetHalf = (halfName === 'top') ? col.top : col.bottom;

            if (typeof fromIndex === 'number' && fromIndex >= 0) {
              const removed = targetHalf.blocks.splice(fromIndex, 1)[0];
              targetHalf.sum -= removed;
              render();
            }
          });

          b.appendChild(delBtn);

          b.addEventListener('dragstart', (e) => {
            dragInfo = { colId: col.id, half: halfName, fromIndex };
            b.classList.add('dragging');
            e.dataTransfer.setData('text/plain', JSON.stringify(dragInfo));
            e.dataTransfer.effectAllowed = 'move';
          });

          b.addEventListener('dragend', () => {
            b.classList.remove('dragging');
            dragInfo = null;
            cleanupIndicator();
          });

          return b;
        }

        function wireHalfDnD(halfEl, halfName) {
          halfEl.addEventListener('dragover', (e) => {
            e.preventDefault();

            const data = dragInfo || (() => {
              try { return JSON.parse(e.dataTransfer.getData('text/plain')); } catch { return null; }
            })();

            if (!data || data.colId !== col.id || data.half !== halfName) {
              cleanupIndicator();
              return;
            }

            const idx = getInsertIndex(halfEl, e.clientY);
            placeIndicator(halfEl, idx);
            e.dataTransfer.dropEffect = 'move';
            halfEl.classList.add('drag-over');
          });

          halfEl.addEventListener('dragleave', (e) => {
            if (!halfEl.contains(e.relatedTarget)) {
              halfEl.classList.remove('drag-over');
              cleanupIndicator();
            }
          });

          halfEl.addEventListener('drop', (e) => {
            e.preventDefault();
            halfEl.classList.remove('drag-over');

            const data = dragInfo || (() => {
              try { return JSON.parse(e.dataTransfer.getData('text/plain')); } catch { return null; }
            })();

            if (!data || data.colId !== col.id || data.half !== halfName) {
              cleanupIndicator();
              return;
            }

            const toIndex = getInsertIndex(halfEl, e.clientY);
            moveWithinHalf(halfName, data.fromIndex, toIndex);
            cleanupIndicator();
            render();
          });
        }

        // TOP
        const topHalf = document.createElement('div');
        topHalf.className = 'col-half';
        col.top.blocks.forEach((h, i) => topHalf.appendChild(makeBlock(h, 'top', i)));
        wireHalfDnD(topHalf, 'top');

        const sep = document.createElement('div');
        sep.className = 'half-separator';

        // BOTTOM
        const bottomHalf = document.createElement('div');
        bottomHalf.className = 'col-half';
        col.bottom.blocks.forEach((h, i) => bottomHalf.appendChild(makeBlock(h, 'bottom', i)));
        wireHalfDnD(bottomHalf, 'bottom');

        body.appendChild(topHalf);
        body.appendChild(sep);
        body.appendChild(bottomHalf);

        card.appendChild(body);

        // Footer
        const foot = document.createElement('div');
        foot.className = 'col-foot';
        const total = col.top.sum + col.bottom.sum;
        foot.innerHTML = `Usado H${total}/180 · Arriba H${col.top.sum}/90 · Abajo H${col.bottom.sum}/90`;

        shell.appendChild(topBar);
        shell.appendChild(card);
        shell.appendChild(foot);

        columnsGrid.appendChild(shell);
      });
    }

    // ✅ Inicializa color puertas
    state.selectedColor = colorDoorSelect?.value || '';
    colorDoorSelect?.addEventListener('change', () => {
      state.selectedColor = colorDoorSelect.value || '';
      render();
    });

    // ✅ Inicializa borde columnas
    setColumnsBorderColor(colorBodySelect?.value || '#000');
    colorBodySelect?.addEventListener('change', () => {
      setColumnsBorderColor(colorBodySelect.value || '#000');
    });

    // Añadir columna
    addColumnBtn.addEventListener('click', () => {
      state.columns.push({
        id: uid(),
        top: { blocks: [], sum: 0 },
        bottom: { blocks: [], sum: 0 }
      });
      render();
    });

    // =========================
    // ✅ CARGAR CONFIG (si existe)
    // =========================
    const pre = window.PRELOADED_CONFIG || null;

    function selectOption(group, value){
      if (!value) return;
      const btn = document.querySelector(`.option-row[data-group="${group}"] .option-card[data-value="${value}"]`);
      if (btn) btn.click();
    }

    function setSelectValue(sel, value){
      if (!sel || !value) return;
      sel.value = value;
    }

    if (pre && Object.keys(pre).length) {
      selectOption('background_size', pre.background_size);
      selectOption('placement', pre.placement);
      selectOption('material', pre.material);

      setSelectValue(colorDoorSelect, pre.colorDoor);
      state.selectedColor = pre.colorDoor || '';

      setSelectValue(colorBodySelect, pre.colorBody);
      setColumnsBorderColor(pre.colorBody || '#000');

      if (Array.isArray(pre.columns)) {
        state.columns = pre.columns.map(c => ({
          id: uid(),
          top: {
            blocks: (c.top?.blocks || []),
            sum: (c.top?.total ?? (c.top?.blocks || []).reduce((a,b)=>a+b,0))
          },
          bottom: {
            blocks: (c.bottom?.blocks || []),
            sum: (c.bottom?.total ?? (c.bottom?.blocks || []).reduce((a,b)=>a+b,0))
          }
        }));
      }

      render();
    } else {
      render();
    }

    // Submit
    document.getElementById('configForm').addEventListener('submit', function(e) {
      const bg = document.getElementById('background_size').value;
      const pl = document.getElementById('placement').value;
      const material = document.getElementById('material').value;
      const colorDoor = document.getElementById('color-door').value;
      const colorBody = document.getElementById('color-body').value;

      const error = document.getElementById('formError');
      error.textContent = '';

      if (!bg || !pl || !material || !colorDoor || !colorBody) {
        e.preventDefault();
        error.textContent = 'Selecciona medida, interior/exterior, material, color puerta y color cuerpo.';
        return;
      }
      if (state.columns.length === 0) {
        e.preventDefault();
        error.textContent = 'Añade al menos 1 columna.';
        return;
      }

      const incompleteIndex = state.columns.findIndex(c => c.top.sum !== 90 || c.bottom.sum !== 90);
      if (incompleteIndex !== -1) {
        e.preventDefault();
        const colNum = incompleteIndex + 1;
        const topLeft = 90 - state.columns[incompleteIndex].top.sum;
        const botLeft = 90 - state.columns[incompleteIndex].bottom.sum;

        error.textContent = `La columna ${colNum} no está completa. Falta: arriba H${Math.max(0, topLeft)}, abajo H${Math.max(0, botLeft)}.`;
        return;
      }

      const columnsPayload = state.columns.map(c => ({
        top: { blocks: c.top.blocks, total: c.top.sum },
        bottom: { blocks: c.bottom.blocks, total: c.bottom.sum },
        total: c.top.sum + c.bottom.sum
      }));

      const ensureHidden = (name, value) => {
        let el = document.querySelector('input[name="' + name + '"]');
        if (!el) {
          el = document.createElement('input');
          el.type = 'hidden';
          el.name = name;
          this.appendChild(el);
        }
        el.value = value;
      };

      ensureHidden.call(this, 'project_name', 22);
      ensureHidden.call(this, 'colorDoor', colorDoor);
      ensureHidden.call(this, 'colorBody', colorBody);
      const type = document.getElementById('type')?.value || '';

      ensureHidden.call(this, 'payload', JSON.stringify({
        type: type,
        background_size: bg,
        placement: pl,
        material: material,
        colorDoor: colorDoor,
        colorBody: colorBody,
        columns: columnsPayload
      }));
    });

  })();
  });
  </script>
{% endblock %}
