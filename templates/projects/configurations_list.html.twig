{% extends 'layout.html.twig' %}
{% block page_title %}Configuraciones{% endblock %}

{% block stylesheets %}
  {{ parent() }}
  <style>
    :root{ --hscale: 1.7; }

    /* ===== PAGE WRAP ===== */
    .wrap{ max-width: 1400px; margin: 26px auto; padding: 0 14px; }
    .muted{ color:#6b7280; font-size:16px; }

    h1.page-title{
      margin:0;
      font-size:34px;
      letter-spacing:-0.02em;
    }

    /* ===== TOP INFO BAR (cliente/email/teléfono/ubicación) ===== */
    .info-bar{
      margin-top:14px;
      background:#fff;
      border:1px solid rgba(15,23,42,.12);
      border-radius:14px;
      padding:14px;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:14px;
      align-items:center;
    }
    @media (max-width: 1020px){
      .info-bar{ grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 620px){
      .info-bar{ grid-template-columns: 1fr; }
    }

    .info-item{
      display:flex;
      align-items:center;
      gap:12px;
      min-height:52px;
    }
    .info-ico{
      width:44px;
      height:44px;
      border-radius:999px;
      background: rgba(11,118,216,.10);
      display:flex;
      align-items:center;
      justify-content:center;
      flex:0 0 44px;
    }
    .info-ico svg{ display:block; }
    .info-k{ font-size:12px; color:#6b7280; font-weight:900; }
    .info-v{ font-size:14px; font-weight:900; margin-top:2px; }

    /* ===== ACTIONS ROW ===== */
    .top-actions{
      margin-top:14px;
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
    }

    /* ===== CARDS ===== */
    .card{
      background:#fff;
      border:1px solid rgba(15,23,42,.12);
      border-radius:16px;
      padding:16px;
      margin-top:16px;
    }

    /* ===== CONFIG ITEM CARD ===== */
    .config-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
    }
    .config-title{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      font-weight:900;
      font-size:18px;
    }
    .config-sub{
      margin-top:6px;
      color:#6b7280;
      font-size:14px;
    }

    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .btn{
      border:1px solid rgba(15,23,42,.12);
      background:#fff;
      border-radius:12px;
      padding:10px 14px;
      font-weight:900;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:10px;
      text-decoration:none;
      color:#0b1220;
      font-size:13px;
      box-shadow: 0 1px 0 rgba(15,23,42,.04);
    }
    .btn:hover{ background: rgba(2,6,23,.03); }
    .btn.primary{
      background:#0b76d8;
      border-color:#0b76d8;
      color:#fff;
    }
    .btn.primary:hover{ filter: brightness(.97); }
    .btn.icon svg{ display:block; }

    .btn.accept{
      background: #23C920;
      color: #fff;
    }
    
    .config-body{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr 1.25fr;
      gap:14px;
      align-items:stretch;
    }
    @media (max-width: 980px){
      .config-body{ grid-template-columns: 1fr; }
    }

    /* KV CARDS */
    .kvs{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .kv{
      border:0;
      border-radius:14px;
      padding:14px;
      background:#f8fafc;
      min-height:74px;
    }
    .kv .k{ font-size:12px; color:#6b7280; font-weight:900; }
    .kv .v{ font-size:14px; font-weight:900; margin-top:4px; }

    .kv.wide{ grid-column: 1 / -1; }

    /* Color swatch */
    .swatch{
      display:inline-flex;
      align-items:center;
      gap:10px;
    }
    .dot{
      width:14px;
      height:14px;
      border-radius:4px;
      border:1px solid rgba(0,0,0,.15);
      display:inline-block;
    }

    /* ===== MINI PREVIEW (NO CAMBIAR DIBUJO) ===== */
    .mini-wrap{
      border:0;
      border-radius:14px;
      padding:14px;
      background:#f8fafc;
    }
    .mini-title{
      font-weight:900;
      color:#0b1220;
      margin-bottom:10px;
    }

    .cols{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:6px;
    }

    .col-shell{ width:80px; display:flex; flex-direction:column; gap:5px; }
    .col-topbar{
      padding:5px 7px;
      border-radius:8px;
      background:#003b73;
      color:#fff;
      font-weight:900;
      font-size:11px;
      text-align:center;
    }

    .col-card{
      width:80px;
      border-style:solid;
      border-color: var(--col-border, #000);
      border-left-width:3px;
      border-right-width:3px;
      border-top-width:6px;
      border-bottom-width:6px;
      border-radius:8px;
      overflow:hidden;
      background:#f7f7f7;
    }

    .col-body{
      height:calc(180px * var(--hscale));
      background:#eaeaea;
      display:flex;
      flex-direction:column;
    }

    .col-half{
      height:calc(90px * var(--hscale));
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }

    .half-sep{ border-top:2px dashed rgba(0,0,0,.25); height:0; }

    .door{
      width:100%;
      border-left:1px solid rgba(44,62,80,.7);
      border-right:1px solid rgba(44,62,80,.7);
      border-top:1px solid rgba(44,62,80,.7);
      background: var(--door-color, #3a9efc);
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .door.last{ border-bottom:1px solid rgba(44,62,80,.7); }

    .door .num{
      position:absolute;
      left:4px;
      top:3px;
      font-weight:900;
      font-size:9px;
      background: rgba(0,0,0,.65);
      color:#fff;
      border-radius:999px;
      padding:1px 5px;
      line-height:1.2;
    }

    .door.screen{ padding:3px; }
    .door.screen img{
      width:135%;
      height:135%;
      object-fit:contain;
      pointer-events:none;
      user-select:none;
    }

    /* helper */
    .badge{
      display:inline-flex;
      align-items:center;
      padding:4px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      border:1px solid rgba(15,23,42,.10);
      background:#fff;
      margin-left:6px;
    }
  </style>
{% endblock %}

{% block content %}
<div class="wrap">

  <h1 class="page-title">Configuraciones del proyecto</h1>
  <div class="muted" style="margin-top:6px;">
    Proyecto: <b>{{ project.projectName }}</b> · Cliente: <b>{{ project.clientName }}</b>
  </div>

  {# Barra info (si algún campo no existe, muestra —) #}
  <div class="info-bar">
    <div class="info-item">
      <div class="info-ico" aria-hidden="true">
        <!-- user -->
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
          <path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Z" stroke="#0b76d8" stroke-width="2"/>
          <path d="M4 21a8 8 0 0 1 16 0" stroke="#0b76d8" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      <div>
        <div class="info-k">Cliente</div>
        <div class="info-v">{{ project.clientName ?: '—' }}</div>
      </div>
    </div>

    <div class="info-item">
      <div class="info-ico" aria-hidden="true">
        <!-- mail -->
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
          <path d="M4 6h16v12H4V6Z" stroke="#0b76d8" stroke-width="2" stroke-linejoin="round"/>
          <path d="m4 7 8 6 8-6" stroke="#0b76d8" stroke-width="2" stroke-linejoin="round"/>
        </svg>
      </div>
      <div>
        <div class="info-k">Email</div>
        <div class="info-v">{{ project.email ?: '—' }}</div>
      </div>
    </div>

    <div class="info-item">
      <div class="info-ico" aria-hidden="true">
        <!-- phone -->
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
          <path d="M22 16.9v3a2 2 0 0 1-2.2 2 19.8 19.8 0 0 1-8.6-3.1A19.5 19.5 0 0 1 3.2 10.8 19.8 19.8 0 0 1 .1 2.2 2 2 0 0 1 2.1 0h3a2 2 0 0 1 2 1.7c.1.9.3 1.8.6 2.7a2 2 0 0 1-.4 2.1L6 8a16 16 0 0 0 10 10l1.5-1.3a2 2 0 0 1 2.1-.4c.9.3 1.8.5 2.7.6A2 2 0 0 1 22 16.9Z" stroke="#0b76d8" stroke-width="2" stroke-linejoin="round"/>
        </svg>
      </div>
      <div>
        <div class="info-k">Teléfono</div>
        <div class="info-v">{{ project.phone ?: '—' }}</div>
      </div>
    </div>

    <div class="info-item">
      <div class="info-ico" aria-hidden="true">
        <!-- pin -->
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
          <path d="M12 22s7-5.2 7-12a7 7 0 1 0-14 0c0 6.8 7 12 7 12Z" stroke="#0b76d8" stroke-width="2" stroke-linejoin="round"/>
          <path d="M12 10.5a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z" stroke="#0b76d8" stroke-width="2"/>
        </svg>
      </div>
      <div>
        <div class="info-k">Ubicación</div>
        <div class="info-v">{{ project.city ?: '—' }}</div>
      </div>
    </div>
  </div>

  <div class="top-actions">
    <a class="btn" href="{{ path('projects_list', { user_id: app.user.id }) }}">
      <!-- arrow -->
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M15 18 9 12l6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      Volver a proyectos
    </a>

    {% if project.status == 0%}
      <a class="btn primary" href="{{ path('configuration_type', { project_id: project.id }) }}">
        <!-- plus -->
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 5v14M5 12h14" stroke="white" stroke-width="2" stroke-linecap="round"/>
        </svg>
        Nueva configuración
      </a>
    {% endif %}
  </div>

  {% if items is empty %}
    <div class="card">
      <b>No hay configuraciones aún.</b>
      <div style="margin-top:10px;">
        <a class="btn primary" href="{{ path('configuration_type', { project_id: project.id }) }}">
          Nueva configuración
        </a>
      </div>
    </div>
  {% else %}

    {% for it in items %}
      {% set c = it.configuration %}
      {% set p = it.payload %}
      {% if p is not iterable %}{% set p = {} %}{% endif %}

      {% set columns = p.columns ?? [] %}
      {% set doorColor = p.colorDoor ?? '#3a9efc' %}
      {% set doorColorRal = p.colorDoorRal ?? p.colorDoor ?? '#3a9efc' %}
      {% set bodyColor = p.colorBody ?? '#000' %}
      {% set bodyColorRal = p.colorBodyRal ?? p.colorBody ?? '#000' %}

      {% set type = p.type ?? '—' %}

      <div class="card">
        <div class="config-head">
          <div>
            <div class="config-title">
              Configuración #{{ c.id }}
              {% if c.status == 0 %}
                <span class="badge open">Abierta</span>
              {% elseif c.status == 1 %}
                <span class="badge closed">Cerrada</span>
              {% else %}
                <span class="badge accepted">Aceptada</span>
              {% endif %}
            </div>

            <div class="config-sub">
              Tipo: <b>{{ type }}</b>
              {% if c.createdAt is defined and c.createdAt %}
                · Creada: <b>{{ c.createdAt|date('d/m/Y H:i') }}</b>
              {% endif %}
            </div>
          </div>

          <div class="actions">

            {% if project.status == 0  %}
              <a class="btn accept icon" href="{{ path('configuration_accept', { id: c.id }) }}" 
                 onclick="return confirm('¿Seguro que quieres aceptar esta configuración?');">
                <!-- pdf/doc -->
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                  <path d="M14 2v6h6" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                </svg>
                Aceptar configuración
              </a>
            {% endif %}

            {% if project.status == 0%}
              <a class="btn icon" href="{{ path('configuration_copy', { id: c.id }) }}">
                <!-- copy -->
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M9 9h11v11H9V9Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                  <path d="M5 15H4a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Copiar
              </a>
            {% endif %}

            <a class="btn icon" href="{{ path('configuration_summary', { id: c.id }) }}">
              <!-- file -->
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                <path d="M14 2v6h6" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
              </svg>
              Resumen
            </a>
            {% if c.status == 0 and project.status == 0 %}
              <a class="btn primary icon" href="{{ path('configuration_columns', { project_id: project.id, config_id: c.id }) }}">
                <!-- edit -->
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M12 20h9" stroke="white" stroke-width="2" stroke-linecap="round"/>
                  <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5Z" stroke="white" stroke-width="2" stroke-linejoin="round"/>
                </svg>
                Editar
              </a>
            {% endif %}

            <a class="btn icon" href="{{ path('configuration_pdf', { id: c.id }) }}">
              <!-- pdf/doc -->
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                <path d="M14 2v6h6" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
              </svg>
              PDF
            </a>

          </div>
        </div>

        <div class="config-body">
          <div>
            <div class="kvs">
              <div class="kv">
                <div class="k">Estado</div>
                <div class="v">{{ c.statusLabel }}</div>
              </div>

              <div class="kv">
                <div class="k">Columnas</div>
                <div class="v">{{ columns|length }}</div>
              </div>

              <div class="kv">
                <div class="k">Color cuerpo</div>
                <div class="v">
                  <span class="swatch">
                    <span class="dot" style="background: {{ bodyColor }};"></span>
                    {{ bodyColorRal }}
                  </span>
                </div>
              </div>

              <div class="kv">
                <div class="k">Color puerta</div>
                <div class="v">
                  <span class="swatch">
                    <span class="dot" style="background: {{ doorColor }};"></span>
                    {{ doorColorRal }}
                  </span>
                </div>
              </div>

              <div class="kv wide">
                <div class="k">Config ID</div>
                <div class="v">#{{ c.id }}</div>
              </div>
            </div>
          </div>

          <div class="mini-wrap">
            <div class="mini-title">Vista previa (miniatura)</div>

            {% if columns is empty %}
              <div style="margin-top:8px; color:#c0392b; font-weight:900;">
                Sin columnas
              </div>
            {% else %}
              {% set colsToShow = columns|slice(0, 4) %}

              {# ✅ NO cambiar forma de dibujar la miniatura: bloque intacto #}
              <div class="cols" style="--door-color: {{ doorColor }}; --col-border: {{ bodyColor }};">
                {% set doorIndex = 0 %}

                {% for col in colsToShow %}
                  <div class="col-shell">
                    <div class="col-topbar">Col {{ loop.index }}</div>

                    <div class="col-card">
                      <div class="col-body">

                        <div class="col-half">
                          {% for blk in (col.top.blocks ?? []) %}
                            {% set hh = blk.h|default(blk) %}
                            {% set btype = blk.type|default('door') %}

                            {% if btype != 'screen' %}
                              {% set doorIndex = doorIndex + 1 %}
                            {% endif %}

                            <div class="door {{ btype == 'screen' ? 'screen' : '' }} {% if loop.last %}last{% endif %}"
                                 style="height: calc({{ hh }}px * var(--hscale));">
                              {% if btype == 'screen' %}
                                <img src="{{ asset('assets/pantalla.png') }}" alt="Pantalla">
                              {% else %}
                                <div class="num">{{ doorIndex }}</div>
                              {% endif %}
                            </div>
                          {% endfor %}
                        </div>

                        <div class="half-sep"></div>

                        <div class="col-half">
                          {% for blk in (col.bottom.blocks ?? []) %}
                            {% set hh = blk.h|default(blk) %}
                            {% set btype = blk.type|default('door') %}

                            {% if btype != 'screen' %}
                              {% set doorIndex = doorIndex + 1 %}
                            {% endif %}

                            <div class="door {{ btype == 'screen' ? 'screen' : '' }} {% if loop.last %}last{% endif %}"
                                 style="height: calc({{ hh }}px * var(--hscale));">
                              {% if btype == 'screen' %}
                                <img src="{{ asset('assets/pantalla.png') }}" alt="Pantalla">
                              {% else %}
                                <div class="num">{{ doorIndex }}</div>
                              {% endif %}
                            </div>
                          {% endfor %}
                        </div>

                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>

              {% if columns|length > 4 %}
                <div class="muted" style="margin-top:10px;">
                  Mostrando 4 de {{ columns|length }} columnas…
                </div>
              {% endif %}
            {% endif %}
          </div>
        </div>
      </div>
    {% endfor %}

  {% endif %}
</div>
{% endblock %}
