{# ============================================================
   PDF / Documento técnico (sin precios) — con AGRUPACIONES (groups)
   ✅ FIX: que la vista previa se meta en la pág 1 si cabe
   ✅ FIX: patas en PDF (TABLE)
   ✅ FIX: brazos/patas derecha alineados (ancho explícito por grupo)
   ✅ NUEVO: 2 agrupaciones por fila si caben (GRID con TABLE)
   ✅ FIX: SIEMPRE dibuja puertas (también cuando NO hay brazos)
   ============================================================ #}

{% set pxPerH = 2.2 %}

<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <style>
    body{ font-family: DejaVu Sans, Arial, sans-serif; font-size:12px; color:#0b1220; }
    .page{ padding: 18px 22px; }

    /* Header */
    .head{
      border-bottom: 2px solid #0b76d8;
      padding-bottom: 10px;
      margin-bottom: 14px;
    }
    .brand{ font-size: 16px; font-weight: 900; margin:0; color:#003b73; }
    .doc-title{ font-size: 18px; font-weight: 900; margin: 2px 0 0; }
    .meta{ margin-top: 6px; font-size: 11px; color:#6b7280; }

    .row{ font-size:0; margin-top: 10px; }
    .col{ display:inline-block; vertical-align: top; font-size:12px; }
    .col-50{ width:49%; }
    .col-50 + .col-50{ margin-left:2%; }

    .card{
      border:1px solid rgba(15,23,42,.12);
      border-radius:10px;
      padding:10px;
      margin-bottom: 10px;
      background:#fff;
      page-break-inside: avoid;
    }

    /* ✅ permitir que caiga en página 1 si cabe */
    .card-preview{
      padding:25px;
      margin-bottom: 10px;
      background:#fff;
      page-break-inside: auto;
      padding-bottom: 20px;
    }

    .card h3{ margin:0 0 8px; font-size: 12px; font-weight: 900; color:#003b73; }
    .muted{ color:#6b7280; font-size:11px; }

    table{ width:100%; border-collapse: collapse; font-size: 11px; }
    th, td{ border:1px solid #e5e7eb; padding:7px 8px; text-align:left; vertical-align: top; }
    th{ background:#f3f4f6; font-weight:900; color:#111827; width: 40%; }

    .pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.12);
      background:#fbfcfe;
      font-weight:900;
      font-size: 10px;
      color:#003b73;
    }

    /* ===== Cliente 2 por fila (PDF reliable: TABLE) ===== */
    .kvs-table{ width:100%; border-collapse: collapse; }
    .kvs-table td{ border:0; padding:0 0 8px 0; vertical-align: top; }
    .kvs-table td.gap{ width:2%; }
    .kv{
      border:1px solid rgba(15,23,42,.10);
      border-radius:10px;
      padding:8px 10px;
      background:#fbfcfe;
      box-sizing:border-box;
    }
    .kv .k{ font-size:10px; color:#6b7280; font-weight:900; margin:0; }
    .kv .v{ font-size:11px; font-weight:900; margin:3px 0 0; color:#111827; }

    :root{ --hscale: {{ pxPerH }}px; }

    .cols-wrap{ font-size:0; margin-top: 6px; display:inline-block; }

    .col-shell{
      width:75px;
      display:inline-block;
      padding: 0px;
      vertical-align: top;
      margin-right:10px;
      margin-bottom:10px;
      font-size:12px;
      page-break-inside: avoid;
    }
    .col-shell:last-child{ margin-right:0; }

    .col-card{
      width:75px;
      border-style:solid;
      border-left-width:4px;
      border-right-width:4px;
      border-top-width:6px;
      border-bottom-width:6px;
      border-radius:8px;
      overflow:hidden;
      background:#f7f7f7;
      position:relative;
      z-index:2;
    }

    .col-body{ background:#eaeaea; }
    .col-half{ overflow:hidden; }

    .half-sep{
      border-top:2px dashed rgba(255,255,255,.95);
      border-bottom:1px dashed rgba(0,0,0,.18);
      height:0;
    }

    .door{
      width:100%;
      position:relative;
      border-left:1px solid rgba(11,18,32,.55);
      border-right:1px solid rgba(11,18,32,.55);
      border-top:1px solid rgba(11,18,32,.55);
    }
    .door.last{ border-bottom:1px solid rgba(11,18,32,.55); }
    .door .badges{ position:absolute; right:6px; top:6px; white-space:nowrap; }

    .badge{
      display:inline-block;
      font-size:9px;
      font-weight:900;
      background: rgba(255,255,255,.92);
      border:1px solid rgba(0,0,0,.25);
      border-radius:999px;
      padding:1px 6px;
      margin-left:4px;
    }

    .door.screen{ position:relative; background:#0f172a; }
    .door.screen .screen-img{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      width:95%;
      height:105%;
      display:block;
    }

    /* ===========================
       ✅ SOPORTE SUELO (PDF)
       =========================== */
    .support-wrap{
      --armW: 45px;
      --armOverlap: 22px;
      position: relative;
      display: inline-block;
      padding-left:  calc(var(--armW) - var(--armOverlap));
      padding-right: calc(var(--armW) - var(--armOverlap));
      margin: 14px 0 6px;
      page-break-inside: avoid;
    }

    .arm-img{
      position:absolute;
      top: 60px;
      padding:2px;
      width: var(--armW);
      object-fit: contain;
      z-index: 1;
    }
    .arm-img.left{
      left: calc(-0.95 * var(--armOverlap));
      transform: scaleX(-1);
    }
    .arm-img.right{
      right: calc(-1.48 * var(--armOverlap));
    }

    /* ✅ PATAS (PDF reliable): TABLE */
    .legs-under{
      width:75px;
      margin-top:-6px;
      border-collapse:collapse;
      font-size:0;
    }
    .legs-under td{ border:0; padding:0; width:50%; vertical-align:top; }
    .legs-under td.right{ text-align:right; }

    .leg{
      display:inline-block;
      width:16px;
      height:22px;
      border-radius:6px;
      border:1px solid rgba(0,0,0,.18);
      margin:0;
    }
    .leg.white{ background:#ffffff; }
    .leg.black{ background:#111827; }
    .leg.silver{ background: linear-gradient(135deg, #cbd5e1, #94a3b8); }

    /* ===========================
       ✅ GRID 2 agrupaciones por fila (TABLE)
       =========================== */
    .groups-grid{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
    }
    .groups-grid td{
      border:0;
      padding:0;
      vertical-align:top;
    }
    .groups-grid td.gap{ width:6%; } /* separación horizontal entre celdas */
    .group-cell{ page-break-inside: avoid; }

    /* separación vertical entre filas del grid */
    .row-sep{ height:55px; }

    .footer{
      margin-top: 12px;
      border-top: 1px solid #e5e7eb;
      padding-top: 8px;
      font-size: 10px;
      color:#6b7280;
    }
  </style>
</head>

<body>
<div class="page">

  {# =========================
     Datos base
     ========================= #}
  {% set p = payload ?? {} %}
  {% if p is not iterable %}{% set p = {} %}{% endif %}

  {% set groups = p.groups ?? [] %}
  {% if groups is not iterable %}{% set groups = [] %}{% endif %}

  {% set columnsFlat = p.columns ?? [] %}
  {% if columnsFlat is not iterable %}{% set columnsFlat = [] %}{% endif %}

  {% if groups is empty and columnsFlat is not empty %}
    {% set groups = [columnsFlat] %}
  {% endif %}

  {% set columnsAll = [] %}
  {% for g in groups %}
    {% if g is iterable %}
      {% set columnsAll = columnsAll|merge(g) %}
    {% endif %}
  {% endfor %}

  {% set addons = p.addons ?? {} %}

  {% set doorColor = p.colorDoor ?? '#3a9efc' %}
  {% set doorColorRal = p.colorDoorRal ?? '' %}
  {% set bodyColor = p.colorBody ?? '#000' %}
  {% set bodyColorRal = p.colorBodyRal ?? '' %}

  {% set type = p.type ?? '' %}
  {% set instalacion = p.instalacion ?? '' %}

  {% set selectedType  = p.bracketType ?? '' %}
  {% set selectedColor = p.bracketColor ?? '' %}
  {% set isSoporteSuelo = (instalacion == 'soporte_suelo') %}

  {% set legClass = selectedColor == 'blanco' ? 'white' : (selectedColor == 'plata' ? 'silver' : 'black') %}

  {% if isSoporteSuelo and selectedType == 'brazos' and selectedColor %}
    {% set armSrc =
      selectedColor == 'blanco' ? absolute_url(asset('assets/brazo_blanco.jpg')) :
      (selectedColor == 'plata' ? absolute_url(asset('assets/brazo_plata.jpg')) : absolute_url(asset('assets/brazo_negro.jpg')))
    %}
  {% endif %}

  {% set isHome = (type == 'home') %}
  {% set isZocalo = (isHome and instalacion == 'zocalo') %}
  {% set isEmpotradoLike = (isHome and (instalacion == 'empotrado' or instalacion == 'soporte_suelo')) %}

  {% set topCap    = isZocalo ? (p.topCap|default(90)) : 90 %}
  {% set bottomCap = isZocalo ? 70 : 90 %}
  {% set singleCap = isEmpotradoLike ? (p.singleCap|default(180)) : 180 %}

  {% set previewHeightPx = (isEmpotradoLike ? singleCap : (topCap + bottomCap)) * pxPerH %}
  {% set armHeightPx = previewHeightPx + 28 %}

  {% set fondo = p.fondo ?? '' %}
  {% set material = p.material ?? '' %}
  {% set placement = p.placement ?? '' %}

  {% set fondoLabel =
    fondo == '300' ? 'Serie 300' :
    fondo == '400' ? 'Serie 400' :
    fondo == '500' ? 'Serie 500' : (fondo ?: '—')
  %}
  {% set placementLabel =
    placement == 'interior' ? 'Interior' :
    placement == 'exterior' ? 'Exterior' : (placement ?: '—')
  %}

  {# =========================
     Contadores
     ========================= #}
  {% set doorCounts = {} %}
  {% set totalDoors = 0 %}
  {% set enchCount = 0 %}
  {% set usbCount = 0 %}

  {% for col in columnsAll %}
    {% if col.single is defined and col.single is not empty %}
      {% for blk in (col.single.blocks ?? []) %}
        {% set bType = blk.type ?? 'door' %}
        {% set h = blk.h ?? blk %}
        {% if bType != 'screen' %}
          {% set totalDoors = totalDoors + 1 %}
          {% set key = 'H' ~ h %}
          {% set doorCounts = doorCounts|merge({ (key): (doorCounts[key]|default(0) + 1) }) %}
          {% set sel = addons[totalDoors ~ ''] ?? addons[totalDoors] ?? null %}
          {% if sel and sel.socket %}{% set enchCount = enchCount + 1 %}{% endif %}
          {% if sel and sel.usb %}{% set usbCount = usbCount + 1 %}{% endif %}
        {% endif %}
      {% endfor %}
    {% else %}
      {% for blk in (col.top.blocks ?? []) %}
        {% set bType = blk.type ?? 'door' %}
        {% set h = blk.h ?? blk %}
        {% if bType != 'screen' %}
          {% set totalDoors = totalDoors + 1 %}
          {% set key = 'H' ~ h %}
          {% set doorCounts = doorCounts|merge({ (key): (doorCounts[key]|default(0) + 1) }) %}
          {% set sel = addons[totalDoors ~ ''] ?? addons[totalDoors] ?? null %}
          {% if sel and sel.socket %}{% set enchCount = enchCount + 1 %}{% endif %}
          {% if sel and sel.usb %}{% set usbCount = usbCount + 1 %}{% endif %}
        {% endif %}
      {% endfor %}
      {% for blk in (col.bottom.blocks ?? []) %}
        {% set bType = blk.type ?? 'door' %}
        {% set h = blk.h ?? blk %}
        {% if bType != 'screen' %}
          {% set totalDoors = totalDoors + 1 %}
          {% set key = 'H' ~ h %}
          {% set doorCounts = doorCounts|merge({ (key): (doorCounts[key]|default(0) + 1) }) %}
          {% set sel = addons[totalDoors ~ ''] ?? addons[totalDoors] ?? null %}
          {% if sel and sel.socket %}{% set enchCount = enchCount + 1 %}{% endif %}
          {% if sel and sel.usb %}{% set usbCount = usbCount + 1 %}{% endif %}
        {% endif %}
      {% endfor %}
    {% endif %}
  {% endfor %}

  {# =========================
     Cabecera
     ========================= #}
  <div class="head">
    <div class="row" style="margin-top:0;">
      <div class="col col-50">
        <p class="brand">Kuik</p>
        <p class="muted" style="margin:2px 0 0;">
          Documento técnico (sin precios)<br>
          Configurador Kuik
        </p>
      </div>
      <div class="col col-50" style="text-align:right;">
        <p class="doc-title" style="margin:0;">Presupuesto</p>
        <div class="meta">
          Nº: <b>#{{ configuration.id }}</b><br>
          Fecha: <b>{{ "now"|date("d/m/Y") }}</b>
        </div>
      </div>
    </div>
  </div>

  {# =========================
     Cliente + Proyecto
     ========================= #}
  <div class="card">
    <h3>Datos del cliente</h3>

    <table class="kvs-table">
      <tbody>
        <tr>
          <td><div class="kv"><div class="k">Proyecto</div><div class="v">{{ project.projectName ?? '—' }}</div></div></td>
          <td class="gap"></td>
          <td><div class="kv"><div class="k">Cliente</div><div class="v">{{ project.clientName ?? '—' }}</div></div></td>
        </tr>
        <tr>
          <td><div class="kv"><div class="k">Email</div><div class="v">{{ project.email ?: '—' }}</div></div></td>
          <td class="gap"></td>
          <td><div class="kv"><div class="k">Teléfono</div><div class="v">{{ project.phone ?: '—' }}</div></div></td>
        </tr>
        <tr>
          <td><div class="kv"><div class="k">Ciudad</div><div class="v">{{ project.city ?: '—' }}</div></div></td>
          <td class="gap"></td>
          <td><div class="kv"><div class="k">Dirección</div><div class="v">{{ project.address ?: '—' }}</div></div></td>
        </tr>
      </tbody>
    </table>
  </div>

  {# =========================
     Vista previa (2 grupos por fila) ✅ FIX: siempre dibuja puertas
     ========================= #}
  <div class="card-preview">

    {% if groups is empty %}
      <div style="color:#c0392b; font-weight:900;">No hay columnas en esta configuración.</div>
    {% else %}

      {% set doorIndex = 0 %}

      <table class="groups-grid">
        <tbody>
        {% for groupCols in groups %}
          {% if groupCols is not iterable %}{% set groupCols = [] %}{% endif %}

          {# abrir fila cada 2 grupos #}
          {% if loop.index0 % 2 == 0 %}
            <tr>
          {% endif %}

          <td class="group-cell" style="width:47%;">
            {% set n = groupCols|length %}
            {% set groupW = n > 0 ? (n * 75 + (n - 1) * 10) : 0 %}

            <div class="support-wrap" style="width: {{ groupW }}px;">

              {# brazos solo si toca #}
              {% if isSoporteSuelo and selectedType == 'brazos' and selectedColor %}
                <img class="arm-img left"  src="{{ armSrc }}" alt="Brazo izquierdo" style="height: {{ armHeightPx }}px;">
                <img class="arm-img right" src="{{ armSrc }}" alt="Brazo derecho"  style="height: {{ armHeightPx }}px;">
              {% endif %}

              <div class="cols-wrap" style="width: {{ groupW }}px;">
                {% for col in groupCols %}
                  <div class="col-shell">

                    <div class="col-card" style="border-color: {{ bodyColor }};">
                      <div class="col-body" style="
                        {% if col.single is defined and col.single is not empty %}
                          height: {{ singleCap * pxPerH }}px;
                        {% else %}
                          height: {{ (topCap + bottomCap) * pxPerH }}px;
                        {% endif %}
                      ">

                        {% if col.single is defined and col.single is not empty %}

                          <div class="col-half" style="height: {{ singleCap * pxPerH }}px;">
                            {% for blk in (col.single.blocks ?? []) %}
                              {% set bType = blk.type ?? 'door' %}
                              {% set h = blk.h ?? blk %}

                              {% if bType == 'screen' %}
                                <div class="door screen {% if loop.last %}last{% endif %}"
                                     style="height: {{ h * pxPerH }}px; background: {{ doorColor }};">
                                  <img class="screen-img" src="{{ absolute_url(asset('assets/pantalla.png')) }}" alt="Pantalla">
                                </div>
                              {% else %}
                                {% set doorIndex = doorIndex + 1 %}
                                {% set sel = addons[doorIndex ~ ''] ?? addons[doorIndex] ?? null %}
                                <div class="door {% if loop.last %}last{% endif %}"
                                     style="height: {{ h * pxPerH }}px; background: {{ doorColor }};">
                                  
                                </div>
                              {% endif %}
                            {% endfor %}
                          </div>

                        {% else %}

                          <div class="col-half" style="height: {{ topCap * pxPerH }}px;">
                            {% for blk in (col.top.blocks ?? []) %}
                              {% set bType = blk.type ?? 'door' %}
                              {% set h = blk.h ?? blk %}

                              {% if bType == 'screen' %}
                                <div class="door screen {% if loop.last %}last{% endif %}"
                                     style="height: {{ h * pxPerH }}px; background: {{ doorColor }};">
                                  <img class="screen-img" src="{{ absolute_url(asset('assets/pantalla.png')) }}" alt="Pantalla">
                                </div>
                              {% else %}
                                {% set doorIndex = doorIndex + 1 %}
                                {% set sel = addons[doorIndex ~ ''] ?? addons[doorIndex] ?? null %}
                                <div class="door {% if loop.last %}last{% endif %}"
                                     style="height: {{ h * pxPerH }}px; background: {{ doorColor }};">
                                 
                                </div>
                              {% endif %}
                            {% endfor %}
                          </div>

                          {#<div class="half-sep"></div>#}

                          <div class="col-half" style="height: {{ bottomCap * pxPerH }}px;">
                            {% for blk in (col.bottom.blocks ?? []) %}
                              {% set bType = blk.type ?? 'door' %}
                              {% set h = blk.h ?? blk %}

                              {% if bType == 'screen' %}
                                <div class="door screen {% if loop.last %}last{% endif %}"
                                     style="height: {{ h * pxPerH }}px; background: {{ doorColor }};">
                                  <img class="screen-img" src="{{ absolute_url(asset('assets/pantalla.png')) }}" alt="Pantalla">
                                </div>
                              {% else %}
                                {% set doorIndex = doorIndex + 1 %}
                                {% set sel = addons[doorIndex ~ ''] ?? addons[doorIndex] ?? null %}
                                <div class="door {% if loop.last %}last{% endif %}"
                                     style="height: {{ h * pxPerH }}px; background: {{ doorColor }};">
                                
                                </div>
                              {% endif %}
                            {% endfor %}
                          </div>

                        {% endif %}

                      </div>
                    </div>

                    {% if isSoporteSuelo and selectedType == 'patas' and selectedColor %}
                      <table class="legs-under">
                        <tr>
                          <td><span class="leg {{ legClass }}"></span></td>
                          <td class="right"><span class="leg {{ legClass }}"></span></td>
                        </tr>
                      </table>
                    {% endif %}

                  </div>
                {% endfor %}
              </div>
            </div>

          </td>

          <td class="gap"></td>

          {% if loop.index0 % 2 == 1 %}
            </tr>
            <tr><td colspan="3" class="row-sep"></td></tr>
          {% endif %}
        {% endfor %}

        {% if groups|length % 2 == 1 %}
          <td style="width:47%;"></td>
          </tr>
        {% endif %}
        </tbody>
      </table>

    {% endif %}
  </div>

  {# =========================
     Configuración + puertas
     ========================= #}
  <div class="row">
    <div class="col col-50">
      <div class="card">
        <h3>Configuración</h3>
        <table>
          <tbody>
            <tr><th>Tipo</th><td><span class="pill">{{ p.type ?? '—' }}</span></td></tr>
            <tr><th>Instalación</th><td>{{ instalacion ?: '—' }}</td></tr>
            <tr><th>Medida de fondo</th><td>{{ fondoLabel }}</td></tr>
            <tr><th>Interior / Exterior</th><td>{{ placementLabel }}</td></tr>
            <tr><th>Material</th><td>{{ material ?: '—' }}</td></tr>
            <tr><th>Color puerta</th><td>{{ doorColorRal ?: '—' }}</td></tr>
            <tr><th>Color cuerpo</th><td>{{ bodyColorRal ?: '—' }}</td></tr>
            <tr><th>Nº columnas</th><td>{{ columnsAll|length }}</td></tr>
            {% if isSoporteSuelo %}
              <tr><th>Soporte</th><td>{{ selectedType ?: '—' }} {{ selectedColor ?: '' }}</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="col col-50">
      <div class="card">
        <h3>Puertas y complementos</h3>

        <table>
          <tbody>
            <tr><th>Total puertas</th><td><b>{{ totalDoors }}</b></td></tr>
            <tr><th>ENCH usados</th><td>{{ enchCount }}</td></tr>
            <tr><th>USB usados</th><td>{{ usbCount }}</td></tr>
          </tbody>
        </table>

        <div style="height:8px;"></div>

        <table>
          <thead>
            <tr>
              <th style="width:40%;">Tipo de puerta</th>
              <th>Cantidad</th>
            </tr>
          </thead>
          <tbody>
            {% for key, count in doorCounts %}
              <tr><td>{{ key }}</td><td>{{ count }}</td></tr>
            {% endfor %}
            {% if doorCounts is empty %}
              <tr><td colspan="2">—</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="footer">
    Documento generado automáticamente desde el configurador. Sin precios ni condiciones comerciales.
  </div>

</div>
</body>
</html>